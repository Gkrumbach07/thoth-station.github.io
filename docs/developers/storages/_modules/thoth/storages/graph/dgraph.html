<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>thoth.storages.graph.dgraph &#8212; Thoth Storages 0.14.8 documentation</title>
    <link rel="stylesheet" href="../../../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123174547-2']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../../../index.html">Thoth Storages 0.14.8 documentation</a> &#187;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thoth.storages.graph.dgraph</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># thoth-storages</span>
<span class="c1"># Copyright(C) 2019 Francesco Murdaca, Fridolin Pokorny</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and / or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;A Dgraph server adapter communicating via gRPC.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Set</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">ChainMap</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">nan</span>

<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">pydgraph</span>

<span class="kn">from</span> <span class="nn">thoth.common</span> <span class="k">import</span> <span class="n">OpenShift</span>
<span class="kn">from</span> <span class="nn">thoth.common</span> <span class="k">import</span> <span class="n">RuntimeEnvironment</span> <span class="k">as</span> <span class="n">RuntimeEnvironmentConfig</span>
<span class="kn">from</span> <span class="nn">thoth.common</span> <span class="k">import</span> <span class="n">HardwareInformation</span> <span class="k">as</span> <span class="n">HardwareInformationConfig</span>
<span class="kn">from</span> <span class="nn">thoth.python</span> <span class="k">import</span> <span class="n">Pipfile</span>
<span class="kn">from</span> <span class="nn">thoth.python</span> <span class="k">import</span> <span class="n">PipfileLock</span>

<span class="kn">from</span> <span class="nn">..base</span> <span class="k">import</span> <span class="n">StorageBase</span>
<span class="kn">from</span> <span class="nn">.models_base</span> <span class="k">import</span> <span class="n">enable_vertex_cache</span>
<span class="kn">from</span> <span class="nn">.models_base</span> <span class="k">import</span> <span class="n">VertexBase</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">ALL_MODELS</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">AdviserRun</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">AdvisedSoftwareStack</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">AdviserRunSoftwareEnvironmentInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">AdviserStackInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Advised</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">AnalyzedBy</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">BuildSoftwareEnvironment</span> <span class="k">as</span> <span class="n">BuildSoftwareEnvironmentModel</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">CreatesStack</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">CVE</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DebDepends</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DebDependency</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DebPackageVersion</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DebPreDepends</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DebReplaces</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DependencyMonkeyRun</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DependencyMonkeyRunSoftwareEnvironmentInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">DependsOn</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">EcosystemSolverRun</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">EnvironmentBase</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">HardwareInformation</span> <span class="k">as</span> <span class="n">HardwareInformationModel</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">UserHardwareInformation</span> <span class="k">as</span> <span class="n">UserHardwareInformationModel</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">HasArtifact</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">HasVulnerability</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Identified</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">InspectionBuildSoftwareEnvironmentInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">InspectionRun</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">InspectionRunSoftwareEnvironmentInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">InspectionSoftwareStack</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">InspectionStackInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">InstalledFrom</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">PackageExtractRun</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">PythonFileDigest</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">FoundFile</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">ProvenanceCheckerRun</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">ProvenanceCheckerStackInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">ProvidedBy</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">PythonArtifact</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">PythonPackageIndex</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">PythonPackageRequirement</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">PythonPackageVersion</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">PythonPackageVersionEntity</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">RequirementsInput</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Requires</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Resolved</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">RPMPackageVersion</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">RPMRequirement</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">RunSoftwareEnvironment</span> <span class="k">as</span> <span class="n">RunSoftwareEnvironmentModel</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">UserRunSoftwareEnvironment</span> <span class="k">as</span> <span class="n">UserRunSoftwareEnvironmentModel</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Solved</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">SoftwareStackBase</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">UsedIn</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">UsedInBuild</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">UsedInJob</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">UserSoftwareStack</span>
<span class="kn">from</span> <span class="nn">.performance</span> <span class="k">import</span> <span class="n">ObservedPerformance</span>
<span class="kn">from</span> <span class="nn">.performance</span> <span class="k">import</span> <span class="n">PERFORMANCE_MODEL_BY_NAME</span>

<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="k">import</span> <span class="n">NotFoundError</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="k">import</span> <span class="n">PythonIndexNotRegistered</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="k">import</span> <span class="n">PerformanceIndicatorNotRegistered</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="k">import</span> <span class="n">NotConnected</span>
<span class="kn">from</span> <span class="nn">..advisers</span> <span class="k">import</span> <span class="n">AdvisersResultsStore</span>
<span class="kn">from</span> <span class="nn">..analyses</span> <span class="k">import</span> <span class="n">AnalysisResultsStore</span>
<span class="kn">from</span> <span class="nn">..inspections</span> <span class="k">import</span> <span class="n">InspectionResultsStore</span>
<span class="kn">from</span> <span class="nn">..provenance</span> <span class="k">import</span> <span class="n">ProvenanceResultsStore</span>
<span class="kn">from</span> <span class="nn">..dependency_monkey_reports</span> <span class="k">import</span> <span class="n">DependencyMonkeyReportsStore</span>
<span class="kn">from</span> <span class="nn">..solvers</span> <span class="k">import</span> <span class="n">SolverResultsStore</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="GraphDatabase"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase">[docs]</a><span class="k">class</span> <span class="nc">GraphDatabase</span><span class="p">(</span><span class="n">StorageBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dgraph server adapter communicating via gRPC.&quot;&quot;&quot;</span>

    <span class="n">TLS_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GRAPH_TLS_PATH&quot;</span><span class="p">)</span>
    <span class="n">ENVVAR_HOST_NAME</span> <span class="o">=</span> <span class="s2">&quot;GRAPH_SERVICE_HOST&quot;</span>
    <span class="n">DEFAULT_HOST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">ENVVAR_HOST_NAME</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;localhost:9080&quot;</span>

    <span class="c1"># Depth of traversal when transitive query is performed.</span>
    <span class="n">_TRANSITIVE_QUERY_DEPTH</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tls_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Dgraph server database adapter.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span> <span class="o">=</span> <span class="n">hosts</span> <span class="ow">or</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_HOST</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tls_path</span> <span class="o">=</span> <span class="n">tls_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">TLS_PATH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pydgraph</span><span class="o">.</span><span class="n">DgraphClient</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve client for communicating with DGraph instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotConnected</span><span class="p">(</span><span class="s2">&quot;No client established to talk to a Draph instance&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get hosts configured for this adapter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Disconnect properly on object destruction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<div class="viewcode-block" id="GraphDatabase.create"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a graph adapter, only for one host (syntax sugar).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">hosts</span><span class="o">=</span><span class="p">[</span><span class="n">host</span><span class="p">])</span></div>

<div class="viewcode-block" id="GraphDatabase.is_connected"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.is_connected">[docs]</a>    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if we are connected to a remote Dgraph instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GraphDatabase.connect"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect to a Dgraph via gRPC.&quot;&quot;&quot;</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tls_path</span><span class="p">:</span>
            <span class="n">root_ca_cert</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tls_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;./ca.crt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
            <span class="n">client_cert_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tls_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;./client.user.key&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
            <span class="n">client_cert</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tls_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;./client.user.crt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>

            <span class="n">credentials</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">ssl_channel_credentials</span><span class="p">(</span>
                <span class="n">root_certificates</span><span class="o">=</span><span class="n">root_ca_cert</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">client_cert_key</span><span class="p">,</span> <span class="n">certificate_chain</span><span class="o">=</span><span class="n">client_cert</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pydgraph</span><span class="o">.</span><span class="n">DgraphClientStub</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">pydgraph</span><span class="o">.</span><span class="n">DgraphClient</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.disconnect"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close all connections - disconnect from remote.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">stub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span><span class="p">:</span>
            <span class="n">stub</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GraphDatabase.initialize_schema"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.initialize_schema">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize Dgraph&#39;s schema.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version_self</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="s2">&quot;thoth-storages&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>
        <span class="k">except</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">DistributionNotFound</span><span class="p">:</span>
            <span class="n">version_self</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Dgraph with schema, schema version is </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">version_self</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;schema.rdf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">pydgraph</span><span class="o">.</span><span class="n">Operation</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">alter</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.drop_all"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.drop_all">[docs]</a>    <span class="k">def</span> <span class="nf">drop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Drop all data present inside Dgraph instance.&quot;&quot;&quot;</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Dropping all data on Dgraph&#39;s instance&quot;</span><span class="p">)</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">pydgraph</span><span class="o">.</span><span class="n">Operation</span><span class="p">(</span><span class="n">drop_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">alter</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.normalize_python_package_name"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.normalize_python_package_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Normalize Python package name based on PEP-0503.&quot;&quot;&quot;</span>
        <span class="c1"># Make sure we have normalized names in the graph database according to PEP:</span>
        <span class="c1">#   https://www.python.org/dev/peps/pep-0503/#normalized-names</span>
        <span class="c1"># TODO: use compiled re</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-_.]+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">package_name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>

<div class="viewcode-block" id="GraphDatabase.parse_python_solver_name"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.parse_python_solver_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_python_solver_name</span><span class="p">(</span><span class="n">solver_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse os and Python identifiers encoded into solver name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">solver_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;solver-&quot;</span><span class="p">):</span>
            <span class="n">solver_identifiers</span> <span class="o">=</span> <span class="n">solver_name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;solver-&quot;</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Solver name has to start with &#39;solver-&#39; prefix: </span><span class="si">{solver_name!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">solver_identifiers</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Solver should be in a form of &#39;solver-&lt;os_name&gt;-&lt;os_version&gt;-&lt;python_version&gt;, &quot;</span>
                <span class="n">f</span><span class="s2">&quot;solver name </span><span class="si">{solver_name}</span><span class="s2"> does not correspond to this naming schema&quot;</span>
            <span class="p">)</span>

        <span class="n">python_version</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">python_version</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;py&quot;</span><span class="p">):</span>
            <span class="n">python_version</span> <span class="o">=</span> <span class="n">python_version</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;py&quot;</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Python version encoded into Python solver name does not start with &#39;py&#39; prefix: </span><span class="si">{solver_name}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">python_version</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">python_version</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;os_name&quot;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;os_version&quot;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="n">python_version</span><span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">_query_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform raw query on connected Dgraph instance.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Adapter is not connected to any Dgraph instance.&quot;</span>
        <span class="n">txn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">txn</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="n">read_only</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">txn</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Safe after commit based on docs.</span>
            <span class="n">txn</span><span class="o">.</span><span class="n">discard</span><span class="p">()</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query statistics:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">latency</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_query_raw_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;An async wrapper for a query call.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_query_raw_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Execute multiple queries in parallel.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_raw_async</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

<div class="viewcode-block" id="GraphDatabase.get_analysis_metadata"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_analysis_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_analysis_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata stored for the given analysis document.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(analysis_document_id, </span><span class="si">%s</span><span class="s2">)) {</span>
<span class="s2">                analysis_datetime</span>
<span class="s2">                analysis_document_id</span>
<span class="s2">                package_extract_name</span>
<span class="s2">                package_extract_version</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PackageExtractRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">analysis_document_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Analysis with analysis document if </span><span class="si">{analysis_document_id}</span><span class="s2"> was not found&quot;</span><span class="p">)</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;analysis_datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;analysis_datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="GraphDatabase.run_software_environment_listing"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.run_software_environment_listing">[docs]</a>    <span class="k">def</span> <span class="nf">run_software_environment_listing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">start_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">is_user_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get listing of software environments available for run.&quot;&quot;&quot;</span>
        <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">RunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_user_run</span><span class="p">:</span>
            <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">UserRunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">), first: </span><span class="si">%d</span><span class="s2">, offset: </span><span class="si">%d</span><span class="s2">) {</span>
<span class="s2">                e: environment_name</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">run_software_environment</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">start_offset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="GraphDatabase.build_software_environment_listing"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.build_software_environment_listing">[docs]</a>    <span class="k">def</span> <span class="nf">build_software_environment_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get listing of software environments available for build.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">), first: </span><span class="si">%d</span><span class="s2">, offset: </span><span class="si">%d</span><span class="s2">) {</span>
<span class="s2">                e: environment_name</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">BuildSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">start_offset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]))</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_postprocess_environment_analysis_listing</span><span class="p">(</span>
        <span class="n">query_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">environment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">convert_datetime</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Post-process build/run software environment analysis listing query.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">query_result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No analyses found for environment </span><span class="si">{environment_name!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_datetime</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">query_result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analyzed_by&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;analysis_datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;analysis_datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">analysis</span> <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="n">query_result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analyzed_by&quot;</span><span class="p">,</span> <span class="p">[])]</span>

<div class="viewcode-block" id="GraphDatabase.run_software_environment_analyses_listing"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.run_software_environment_analyses_listing">[docs]</a>    <span class="k">def</span> <span class="nf">run_software_environment_analyses_listing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run_software_environment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">convert_datetime</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_user_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get listing of analyses available for the given software environment for run.&quot;&quot;&quot;</span>
        <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">RunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_user_run</span><span class="p">:</span>
            <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">UserRunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">), first: </span><span class="si">%d</span><span class="s2">, offset: </span><span class="si">%d</span><span class="s2">) @filter(eq(environment_name,&quot;</span><span class="si">%s</span><span class="s2">&quot;)){</span>
<span class="s2">                count:count(environment_name)</span>
<span class="s2">                analyzed_by {</span>
<span class="s2">                    analysis_datetime</span>
<span class="s2">                    analysis_document_id</span>
<span class="s2">                    package_extract_name</span>
<span class="s2">                    package_extract_version</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">run_software_environment</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">start_offset</span><span class="p">,</span>
            <span class="n">run_software_environment_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_environment_analysis_listing</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">run_software_environment_name</span><span class="p">,</span> <span class="n">convert_datetime</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="GraphDatabase.build_software_environment_analyses_listing"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.build_software_environment_analyses_listing">[docs]</a>    <span class="k">def</span> <span class="nf">build_software_environment_analyses_listing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">build_software_environment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">convert_datetime</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get listing of analyses available for the given software environment for build.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">), first: </span><span class="si">%d</span><span class="s2">, offset: </span><span class="si">%d</span><span class="s2">) @filter(eq(environment_name,&quot;</span><span class="si">%s</span><span class="s2">&quot;)){</span>
<span class="s2">                count:count(environment_name)</span>
<span class="s2">                analyzed_by {</span>
<span class="s2">                    analysis_datetime</span>
<span class="s2">                    analysis_document_id</span>
<span class="s2">                    package_extract_name</span>
<span class="s2">                    package_extract_version</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">BuildSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">start_offset</span><span class="p">,</span>
            <span class="n">build_software_environment_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_environment_analysis_listing</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">build_software_environment_name</span><span class="p">,</span> <span class="n">convert_datetime</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="GraphDatabase.python_package_version_exists"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.python_package_version_exists">[docs]</a>    <span class="k">def</span> <span class="nf">python_package_version_exists</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">solver_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given Python package version exists in the graph database.</span>

<span class="sd">        If optional solver_name parameter is set, the call answers if the given package was solved by</span>
<span class="sd">        the given solver. Otherwise, any solver run is taken into account.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index_url</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39; AND eq(index_url, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">index_url</span>

        <span class="k">if</span> <span class="n">solver_name</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            {</span>
<span class="s2">                f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(solver_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) @cascade @normalize {</span>
<span class="s2">                    solved @filter(eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(package_version, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(ecosystem, python)</span><span class="si">%s</span><span class="s2">) {</span>
<span class="s2">                        count: count(~solved)</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">EcosystemSolverRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
                <span class="n">solver_name</span><span class="p">,</span>
                <span class="n">package_name</span><span class="p">,</span>
                <span class="n">package_version</span><span class="p">,</span>
                <span class="n">q</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">                f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(package_version, &quot;</span><span class="si">%s</span><span class="s2">&quot;)</span>
<span class="s2">                AND eq(ecosystem, python)</span><span class="si">%s</span><span class="s2">) {</span>
<span class="s2">                    count(uid)</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">PythonPackageVersionEntity</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
                <span class="n">package_name</span><span class="p">,</span>
                <span class="n">package_version</span><span class="p">,</span>
                <span class="n">q</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.python_package_exists"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.python_package_exists">[docs]</a>    <span class="k">def</span> <span class="nf">python_package_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given Python package exists regardless of version.&quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) {</span>
<span class="s2">                count(uid)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersionEntity</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_construct_filter_eq_from_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Construct a filter query from a dict matching all the properties.&quot;&quot;&quot;</span>
        <span class="n">filter_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dict_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filter_query</span><span class="p">:</span>
                <span class="n">filter_query</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">filter_query</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;eq(</span><span class="si">{key}</span><span class="s1">, &quot;</span><span class="si">{value}</span><span class="s1">&quot;)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filter_query</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot;eq(</span><span class="si">{key}</span><span class="s2">, </span><span class="si">{value}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">filter_query</span>

<div class="viewcode-block" id="GraphDatabase.compute_python_package_version_avg_performance"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.compute_python_package_version_avg_performance">[docs]</a>    <span class="k">def</span> <span class="nf">compute_python_package_version_avg_performance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">packages</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">run_software_environment</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hardware_specs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get average performance of Python packages on the given runtime environment.</span>

<span class="sd">        We derive this average performance based on software stacks we have</span>
<span class="sd">        evaluated on the given software environment for run including the given</span>
<span class="sd">        package in specified version. There are also included stacks that</span>
<span class="sd">        failed for some reason that have negative performance impact on the overall value.</span>

<span class="sd">        There are considered software stacks that include packages listed,</span>
<span class="sd">        they can however include also other packages.</span>

<span class="sd">        Optional parameters additionally slice results - e.g. if run_software_environment is set,</span>
<span class="sd">        it picks only results that match the given parameters criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">packages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No packages provided for the query&quot;</span><span class="p">)</span>

        <span class="c1"># Create a list so we can index packages in log messages, also normalize names according to PEP.</span>
        <span class="n">normalized_packages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">package_tuple</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
            <span class="n">normalized_packages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">package_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">package_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">package_tuple</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">normalized_packages</span><span class="p">):</span>
            <span class="n">package_name</span><span class="p">,</span> <span class="n">package_version</span><span class="p">,</span> <span class="n">index_url</span> <span class="o">=</span> <span class="n">package_tuple</span>
            <span class="n">run_software_env_filter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">run_software_environment</span><span class="p">:</span>
                <span class="n">run_software_env_filter</span> <span class="o">=</span> <span class="s2">&quot;~inspection_software_environment_input @filter(&quot;</span>
                <span class="n">run_software_env_filter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_filter_eq_from_dict</span><span class="p">(</span><span class="n">run_software_environment</span><span class="p">)</span>
                <span class="n">run_software_env_filter</span> <span class="o">+=</span> <span class="s2">&quot;) { uid }&quot;</span>

            <span class="n">hw_filter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">hardware_specs</span><span class="p">:</span>
                <span class="n">hw_filter</span> <span class="o">=</span> <span class="s2">&quot;~used_in_job @filter(&quot;</span>
                <span class="n">hw_filter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_filter_eq_from_dict</span><span class="p">(</span><span class="n">hardware_specs</span><span class="p">)</span>
                <span class="n">hw_filter</span> <span class="o">+=</span> <span class="s2">&quot;) { uid }&quot;</span>

            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            {</span>
<span class="s2">                q(func: has(</span><span class="si">%s</span><span class="s2">)) @cascade @normalize {</span>
<span class="s2">                    uid: uid</span>
<span class="s2">                    ~inspection_stack_input {</span>
<span class="s2">                        ~creates_stack @filter(eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) &quot;&quot;&quot;</span> \
            <span class="sd">&quot;&quot;&quot;AND eq(package_version, &quot;%s&quot;) AND eq(index_url, &quot;%s&quot;)) {</span>
<span class="sd">                            package_name</span>
<span class="sd">                        }</span>
<span class="sd">                    }</span>
<span class="sd">                    %s</span>
<span class="sd">                    %s</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">InspectionRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
                <span class="n">package_name</span><span class="p">,</span>
                <span class="n">package_version</span><span class="p">,</span>
                <span class="n">index_url</span><span class="p">,</span>
                <span class="n">hw_filter</span><span class="p">,</span>
                <span class="n">run_software_env_filter</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw_parallel</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>

        <span class="n">all_uids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]:</span>
                <span class="c1"># No stack was found that would include the given package, return None directly.</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No stack was found for package </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">normalized_packages</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">nan</span>

            <span class="n">uids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]:</span>
                <span class="n">uids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">])</span>

            <span class="n">all_uids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">uids</span><span class="p">))</span>

        <span class="n">all_stacks</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">all_uids</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_stacks</span><span class="p">:</span>
            <span class="c1"># No intersection was found - no stacks which would include all the packages specified found.</span>
            <span class="k">return</span> <span class="n">nan</span>

        <span class="c1"># Now retrieve average performance for each and every micro-benchmark of a performance type.</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inspection_stack_id</span> <span class="ow">in</span> <span class="n">all_stacks</span><span class="p">:</span>
            <span class="c1"># TODO: add performance micro-benchmark type as a parameter</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            {</span>
<span class="sd">                q(func: uid(%s)) @normalize {</span>
<span class="sd">                    observed_performance {</span>
<span class="sd">                        p: overall_score</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">inspection_stack_id</span>
            <span class="p">)</span>
            <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw_parallel</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
        <span class="n">overall_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">performance_indicator_record</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]:</span>
                <span class="n">overall_score</span> <span class="o">+=</span> <span class="n">performance_indicator_record</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No performance indicators found</span>
            <span class="k">return</span> <span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">overall_score</span> <span class="o">/</span> <span class="n">count</span></div>

<div class="viewcode-block" id="GraphDatabase.has_python_solver_error"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.has_python_solver_error">[docs]</a>    <span class="k">def</span> <span class="nf">has_python_solver_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">os_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">os_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">python_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve information whether the given package has any solver error.&quot;&quot;&quot;</span>
        <span class="n">run_software_env</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os_name</span><span class="p">:</span>
            <span class="n">run_software_env</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39; AND eq(os_name, &quot;</span><span class="si">{os_name}</span><span class="s1">&quot;)&#39;</span>

        <span class="k">if</span> <span class="n">os_version</span><span class="p">:</span>
            <span class="n">run_software_env</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39; AND eq(os_version, &quot;</span><span class="si">{os_version}</span><span class="s1">&quot;)&#39;</span>

        <span class="k">if</span> <span class="n">python_version</span><span class="p">:</span>
            <span class="n">run_software_env</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39; AND eq(python_version, &quot;</span><span class="si">{python_version}</span><span class="s1">&quot;)&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(package_version, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(index_url, &quot;</span><span class="si">%s</span><span class="s2">&quot;)</span><span class="si">%s</span><span class="s2">) {</span>
<span class="s2">                e: solver_error</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">,</span>
            <span class="n">index_url</span><span class="p">,</span>
            <span class="n">run_software_env</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Package </span><span class="si">{package_name!r}</span><span class="s2"> in version </span><span class="si">{package_version!r}</span><span class="s2"> from index </span><span class="si">{index_url!r}</span><span class="s2"> not found for &quot;</span>
                <span class="n">f</span><span class="s2">&quot;operating system &#39;</span><span class="si">{os_name}</span><span class="s2">:</span><span class="si">{os_version}</span><span class="s2">&#39;, python version: </span><span class="si">{python_version!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="GraphDatabase.get_all_versions_python_package"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_all_versions_python_package">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_versions_python_package</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">only_known_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">os_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">os_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">python_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">without_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get all versions available for a Python package.&quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os_name</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39; AND eq(os_name, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">os_name</span>

        <span class="k">if</span> <span class="n">os_version</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39; AND eq(os_version, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">os_version</span>

        <span class="k">if</span> <span class="n">python_version</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39; AND eq(python_version, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">python_version</span>

        <span class="k">if</span> <span class="n">without_error</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot; AND eq(solver_error, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot; AND eq(solver_error, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">index_url</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39; AND eq(index_url, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">index_url</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            {</span>
<span class="s2">                f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(package_name, </span><span class="si">%s</span><span class="s2">)</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2"> {</span>
<span class="s2">                    package_version</span>
<span class="s2">                    index_url</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">q</span><span class="p">,</span>
            <span class="s2">&quot;@cascade&quot;</span> <span class="k">if</span> <span class="n">only_known_index</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">python_package</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">python_package</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]]</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_postprocess_retrieve_packages</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Post-process retrieve packages query.&quot;&quot;&quot;</span>
        <span class="n">pp_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pp_result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_version&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pp_result</span><span class="p">[</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]]:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pp_result</span><span class="p">[</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pp_result</span><span class="p">[</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span>
                        <span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_version&quot;</span><span class="p">]</span>
                    <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pp_result</span><span class="p">[</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">package</span><span class="p">[</span><span class="s2">&quot;package_version&quot;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">pp_result</span>

<div class="viewcode-block" id="GraphDatabase.retrieve_unsolved_python_packages"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_unsolved_python_packages">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_unsolved_python_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a dictionary mapping package names to versions that dependencies were not yet resolved.</span>

<span class="sd">        Using solver_name argument the query narrows down to packages that were not resolved by the given solver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solver_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_python_solver_name</span><span class="p">(</span><span class="n">solver_name</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">           f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(NOT eq(os_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND NOT eq(os_version, &quot;</span><span class="si">%s</span><span class="s2">&quot;) &quot;&quot;&quot;</span> \
        <span class="sd">&quot;&quot;&quot;AND NOT eq(python_version, &quot;%s&quot;)) {</span>
<span class="sd">                   package_name:package_name</span>
<span class="sd">                   package_version:package_version</span>
<span class="sd">                }</span>
<span class="sd">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_name&quot;</span><span class="p">],</span>
            <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_version&quot;</span><span class="p">],</span>
            <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;python_version&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_retrieve_packages</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.retrieve_solved_python_packages"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_solved_python_packages">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_solved_python_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">start_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a dictionary mapping package names to versions for dependencies that were already solved.</span>

<span class="sd">        Using count and start_offset is possible to change pagination.</span>
<span class="sd">        Using solver_name argument the query narrows down to packages that were resolved by the given solver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">solver_name</span><span class="p">:</span>
            <span class="n">solver_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_python_solver_name</span><span class="p">(</span><span class="n">solver_name</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="s2">&quot;@filter(&quot;</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39;eq(os_name, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_name&quot;</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39; AND eq(os_version, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_version&quot;</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39; AND eq(python_version, &quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;python_version&quot;</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">           f(func: has(</span><span class="si">%s</span><span class="s2">), first: </span><span class="si">%d</span><span class="s2">, offset: </span><span class="si">%d</span><span class="s2">) </span><span class="si">%s</span><span class="s2"> @normalize {</span>
<span class="s2">               </span><span class="si">%s</span><span class="s2"> {</span>
<span class="s2">                   package_name:package_name</span>
<span class="s2">                   package_version:package_version</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">start_offset</span><span class="p">,</span>
            <span class="n">q</span><span class="p">,</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_retrieve_packages</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.retrieve_unsolvable_python_packages"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_unsolvable_python_packages">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_unsolvable_python_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a dictionary mapping package names to versions of packages that were marked as unsolvable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">solver_name</span><span class="p">:</span>
            <span class="n">filter_str</span> <span class="o">=</span> <span class="s1">&#39;@filter(eq(solver_error, true) AND eq(solver_error_unsolvable, true))&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_str</span> <span class="o">=</span> <span class="s1">&#39;@filter(eq(solver_error, true) AND eq(solver_error_unsolvable, true) &#39;</span> \
                        <span class="n">f</span><span class="s1">&#39;AND eq(solver_name, &quot;</span><span class="si">{solver_name}</span><span class="s1">&quot;))&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">           f(func: has(</span><span class="si">%s</span><span class="s2">)) @normalize{</span>
<span class="s2">               </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> {</span>
<span class="s2">                   package_name:package_name</span>
<span class="s2">                   package_version:package_version</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
            <span class="n">filter_str</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_retrieve_packages</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.retrieve_unsolvable_python_packages_per_run_software_environment"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_unsolvable_python_packages_per_run_software_environment">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_unsolvable_python_packages_per_run_software_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a dictionary mapping package names to versions of packages that were marked as unsolvable.</span>

<span class="sd">        The result is given for a specific run software environment (OS + python version)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solver_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_python_solver_name</span><span class="p">(</span><span class="n">solver_name</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">           f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(os_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(os_version, &quot;</span><span class="si">%s</span><span class="s2">&quot;) &quot;&quot;&quot;</span> \
        <span class="sd">&quot;&quot;&quot;AND eq(python_version, &quot;%s&quot;) AND eq(solver_error, true) AND eq(solver_error_unsolvable, true) AND has(~%s)) {</span>
<span class="sd">                   package_name:package_name</span>
<span class="sd">                   package_version:package_version</span>
<span class="sd">                }</span>
<span class="sd">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_name&quot;</span><span class="p">],</span>
            <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_version&quot;</span><span class="p">],</span>
            <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;python_version&quot;</span><span class="p">],</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_retrieve_packages</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.retrieve_document_list_of_unsolvable_python_packages"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_document_list_of_unsolvable_python_packages">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_document_list_of_unsolvable_python_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a dictionary mapping package names to versions of packages that were marked as unsolvable.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) {</span>
<span class="s2">                solver_document_id:solver_document_id</span>
<span class="s2">                }</span>
<span class="s2">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">document_id</span><span class="p">[</span><span class="s2">&quot;solver_document_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">document_id</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]]</span></div>

<div class="viewcode-block" id="GraphDatabase.retrieve_unparseable_python_packages"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_unparseable_python_packages">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_unparseable_python_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a dictionary mapping package names to versions of packages that couldn&#39;t be parsed by solver.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">           f(func: has(</span><span class="si">%s</span><span class="s2">)) @normalize{</span>
<span class="s2">               </span><span class="si">%s</span><span class="s2"> @filter(eq(solver_error, true) AND eq(solver_error_unparseable, true)) {</span>
<span class="s2">                   package_name:package_name</span>
<span class="s2">                   package_version:package_version</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_retrieve_packages</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.get_all_python_packages_count"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_all_python_packages_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_python_packages_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">without_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve number of Python packages stored in the graph database.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">without_error</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;{</span>
<span class="sd">                f(func: has(%s)) {</span>
<span class="sd">                    package_name</span>
<span class="sd">                }</span>
<span class="sd">                }&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;{</span>
<span class="sd">                f(func: has(%s)) @filter(eq(solver_error, false)) {</span>
<span class="sd">                    package_name</span>
<span class="sd">                }</span>
<span class="sd">                }&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">python_package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">python_package</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]]))</span></div>

<div class="viewcode-block" id="GraphDatabase.get_error_python_packages_count"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_error_python_packages_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_error_python_packages_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">unsolvable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">unparseable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve number of Python packages stored in the graph database with error flag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unsolvable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unparseable</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;{</span>
<span class="sd">                f(func: has(%s)) @filter(eq(solver_error, true) &quot;&quot;&quot;</span>
                <span class="sd">&quot;&quot;&quot;AND eq(solver_error_unsolvable, false) AND eq(solver_error_unparseable, false)) {</span>
<span class="sd">                    c: count(uid)</span>
<span class="sd">                }</span>
<span class="sd">            }&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">unsolvable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unparseable</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;{</span>
<span class="sd">                f(func: has(%s)) @filter(eq(solver_error_unsolvable, true)) {</span>
<span class="sd">                    c: count(uid)</span>
<span class="sd">                }</span>
<span class="sd">                }&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">unparseable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unsolvable</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;{</span>
<span class="sd">                f(func: has(%s)) @filter(eq(solver_error_unparseable, true)) {</span>
<span class="sd">                    c: count(uid)</span>
<span class="sd">                }</span>
<span class="sd">                }&quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set both flags - unsolvable and unparseable to retrieve error stats&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Internal error - multiple values returned for count query:</span><span class="se">\n</span><span class="si">{query}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.get_solver_documents_count"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_solver_documents_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_solver_documents_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get number of solver documents synced into graph.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        {</span>
<span class="sd">            f(func: has(%s)) {</span>
<span class="sd">                c: count(uid)</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">EcosystemSolverRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;c&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="GraphDatabase.get_analyzer_documents_count"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_analyzer_documents_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_analyzer_documents_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get number of image analysis documents synced into graph.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        {</span>
<span class="sd">            f(func: has(%s)) {</span>
<span class="sd">                c: count(uid)</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">PackageExtractRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;c&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="GraphDatabase.retrieve_dependent_packages"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_dependent_packages">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_dependent_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get mapping package name to package version of packages that depend on the given package.&quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(package_name, </span><span class="si">%s</span><span class="s2">)) @normalize @cascade{</span>
<span class="s2">                ~</span><span class="si">%s</span><span class="s2"> {</span>
<span class="s2">                    package_name:package_name</span>
<span class="s2">                    package_version:package_version</span>
<span class="s2">                    }</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">DependsOn</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_retrieve_packages</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.get_python_package_tuple"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_python_package_tuple">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_python_package_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python_package_node_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get Python&#39;s package name, package version, package index tuple for the given package id.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        {</span>
<span class="sd">            q(func: uid(%s)) @cascade {</span>
<span class="sd">                package_name</span>
<span class="sd">                package_version</span>
<span class="sd">                index_url</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">python_package_node_id</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)[</span><span class="s2">&quot;q&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No package with node id </span><span class="si">{python_package_node_id}</span><span class="s2"> found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">python_package_node_id</span><span class="p">:</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;package_name&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;package_version&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;index_url&quot;</span><span class="p">])</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="GraphDatabase.get_python_package_tuples"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_python_package_tuples">[docs]</a>    <span class="k">def</span> <span class="nf">get_python_package_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python_package_node_ids</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get package name, package version and index URL for each python package node.</span>

<span class="sd">        This query is good to be used in conjunction with query retrieving</span>
<span class="sd">        transitive dependencies. The main benefit of this function is that it</span>
<span class="sd">        performs all the queries in an event loop per each package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">python_package_node_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">python_package_node_id</span> <span class="ow">in</span> <span class="n">python_package_node_ids</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_python_package_tuple</span><span class="p">(</span><span class="n">python_package_node_id</span><span class="p">))</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">))</span>
        <span class="n">results_dict</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="o">*</span><span class="n">results_dict</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_do_retrieve_transitive_dependencies_python_uid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">os_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">os_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">python_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform query for retrieving transitive dependencies, retrieve only uids.&quot;&quot;&quot;</span>
        <span class="n">query_filter</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os_name</span><span class="p">:</span>
            <span class="n">query_filter</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39; AND eq(os_name, &quot;</span><span class="si">{os_name}</span><span class="s1">&quot;)&#39;</span>

        <span class="k">if</span> <span class="n">os_version</span><span class="p">:</span>
            <span class="n">query_filter</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39; AND eq(os_version, &quot;</span><span class="si">{os_version}</span><span class="s1">&quot;)&#39;</span>

        <span class="k">if</span> <span class="n">python_version</span><span class="p">:</span>
            <span class="n">query_filter</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39; AND eq(python_version, &quot;</span><span class="si">{python_version}</span><span class="s1">&quot;)&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            q(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) &quot;&quot;&quot;</span> \
        <span class="sd">&quot;&quot;&quot;AND eq(package_version, &quot;%s&quot;) AND eq(index_url, &quot;%s&quot;)%s) @recurse(depth: %d, loop: false) {</span>
<span class="sd">                uid</span>
<span class="sd">                package_name</span>
<span class="sd">                package_version</span>
<span class="sd">                index_url</span>
<span class="sd">                depends_on</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">,</span>
            <span class="n">index_url</span><span class="p">,</span>
            <span class="n">query_filter</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_TRANSITIVE_QUERY_DEPTH</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)[</span><span class="s2">&quot;q&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query_result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;No packages found for package </span><span class="si">{package_name}</span><span class="s2"> in version </span><span class="si">{package_version}</span><span class="s2"> from </span><span class="si">{index_url}</span><span class="s2">, &quot;</span>
                <span class="n">f</span><span class="s2">&quot;operating system is </span><span class="si">{os_name}</span><span class="s2">:</span><span class="si">{os_version}</span><span class="s2">, python version: </span><span class="si">{python_version}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Post-process if we need perform more search in-depth not to reach serialization issues.</span>
        <span class="c1">#</span>

        <span class="c1"># Adjust to add additional filter for uid based queries.</span>
        <span class="k">if</span> <span class="n">query_filter</span><span class="p">:</span>
            <span class="n">query_filter</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot; @filter(</span><span class="si">{query_filter}</span><span class="s2">)&quot;</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">query_result</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">depth</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">packages_seen</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TRANSITIVE_QUERY_DEPTH</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packages_seen</span><span class="p">:</span>
                <span class="k">assert</span> <span class="s2">&quot;depends_on&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    {</span>
<span class="s2">                        q(func: uid(</span><span class="si">%s</span><span class="s2">)) </span><span class="si">%s</span><span class="s2"> @recurse(depth: </span><span class="si">%d</span><span class="s2">, loop: false) {</span>
<span class="s2">                            uid</span>
<span class="s2">                            depends_on</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">                &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">],</span>
                    <span class="n">query_filter</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_TRANSITIVE_QUERY_DEPTH</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">subquery_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">subquery_result</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span>
                <span class="c1"># We always have one element in the query result - the uid itself.</span>
                <span class="k">if</span> <span class="s2">&quot;depends_on&quot;</span> <span class="ow">in</span> <span class="n">subquery_result</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;depends_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subquery_result</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;depends_on&quot;</span><span class="p">]</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">subquery_result</span><span class="p">,</span> <span class="n">packages_seen</span> <span class="o">|</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]}))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depends_on&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">new_packages_seen</span> <span class="o">=</span> <span class="n">packages_seen</span> <span class="o">|</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]}</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">depth</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">new_packages_seen</span><span class="p">))</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">((</span><span class="n">qr</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">qr</span> <span class="ow">in</span> <span class="n">query_result</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">item</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depends_on&quot;</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]])</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depends_on&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dep</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]]))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_get_python_package_tuples</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ids_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span> <span class="n">transitive_dependencies</span><span class="p">:</span> <span class="n">List</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve tuples representing package name, package version and index url for the given set of ids.&quot;&quot;&quot;</span>
        <span class="n">seen_ids</span> <span class="o">=</span> <span class="n">ids_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">unseen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">transitive_dependencies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_ids</span><span class="p">:</span>
                    <span class="n">unseen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unseen_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Retrieving package tuples for transitive dependencies (count: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">unseen_ids</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">package_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_python_package_tuples</span><span class="p">(</span><span class="n">unseen_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">python_package_id</span><span class="p">,</span> <span class="n">package_tuple</span> <span class="ow">in</span> <span class="n">package_tuples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ids_map</span><span class="p">[</span><span class="n">python_package_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">package_tuple</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">transitive_dependencies</span><span class="p">:</span>
            <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
                <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids_map</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_entries</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="GraphDatabase.retrieve_transitive_dependencies_python"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_transitive_dependencies_python">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_transitive_dependencies_python</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">os_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">os_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">python_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_ids_map</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all transitive dependencies for the given package by traversing dependency graph.</span>

<span class="sd">        It&#39;s much faster to retrieve just dependencies for the transitive</span>
<span class="sd">        dependencies as most of the time is otherwise spent in serialization</span>
<span class="sd">        and deserialization of query results.</span>

<span class="sd">        The ids map represents a map to optimize number of retrievals - not to perform duplicate</span>
<span class="sd">        queries into graph instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_ids_map</span> <span class="o">=</span> <span class="n">_ids_map</span> <span class="k">if</span> <span class="n">_ids_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_retrieve_transitive_dependencies_python_uid</span><span class="p">(</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">,</span>
            <span class="n">index_url</span><span class="p">,</span>
            <span class="n">os_name</span><span class="o">=</span><span class="n">os_name</span><span class="p">,</span>
            <span class="n">os_version</span><span class="o">=</span><span class="n">os_version</span><span class="p">,</span>
            <span class="n">python_version</span><span class="o">=</span><span class="n">python_version</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_python_package_tuples</span><span class="p">(</span><span class="n">_ids_map</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GraphDatabase.retrieve_transitive_dependencies_python_multi"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.retrieve_transitive_dependencies_python_multi">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_transitive_dependencies_python_multi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package_tuples</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">os_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">os_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">python_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all transitive dependencies for a given set of packages by traversing the dependency graph.&quot;&quot;&quot;</span>
        <span class="n">ids_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">package_tuple</span> <span class="ow">in</span> <span class="n">package_tuples</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_transitive_dependencies_python</span><span class="p">(</span>
                <span class="n">package_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">package_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">package_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">os_name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">os_version</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">_ids_map</span><span class="o">=</span><span class="n">ids_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">package_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">paths</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GraphDatabase.solver_records_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.solver_records_exist">[docs]</a>    <span class="k">def</span> <span class="nf">solver_records_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver_document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given solver document record exists.&quot;&quot;&quot;</span>
        <span class="n">solver_document_id</span> <span class="o">=</span> <span class="n">SolverResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">solver_document</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(solver_datetime, &quot;</span><span class="si">%s</span><span class="s2">&quot;) &quot;&quot;&quot;</span> \
        <span class="sd">&quot;&quot;&quot;AND eq(solver_document_id, &quot;%s&quot;) AND eq(solver_name, %s) AND eq(solver_version, %s)) {</span>
<span class="sd">                count(uid)</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
            <span class="n">solver_document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
            <span class="n">solver_document_id</span><span class="p">,</span>
            <span class="n">SolverResultsStore</span><span class="o">.</span><span class="n">get_solver_name_from_document_id</span><span class="p">(</span><span class="n">solver_document_id</span><span class="p">),</span>
            <span class="n">solver_document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer_version&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.solver_document_id_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.solver_document_id_exist">[docs]</a>    <span class="k">def</span> <span class="nf">solver_document_id_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if there is a solver document record with the given id.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        query q($l: string) {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(solver_document_id, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) {</span>
<span class="s2">                count(uid)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">EcosystemSolverRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">solver_document_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Integrity error - multiple solver runs found for the same solver document id: </span><span class="si">{solver_document_id}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.dependency_monkey_document_id_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.dependency_monkey_document_id_exist">[docs]</a>    <span class="k">def</span> <span class="nf">dependency_monkey_document_id_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency_monkey_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given dependency monkey report record exists in the graph database.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">        query q($l: string) {</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(dependency_monkey_document_id, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) {</span>
<span class="s2">                count(uid)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">DependencyMonkeyRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">dependency_monkey_document_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Integrity error - multiple dependency monkey runs found for the &quot;</span>
                <span class="n">f</span><span class="s2">&quot;same dependency monkey document id: </span><span class="si">{dependency_monkey_document_id}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.adviser_document_id_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.adviser_document_id_exist">[docs]</a>    <span class="k">def</span> <span class="nf">adviser_document_id_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adviser_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if there is a adviser document record with the given id.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(adviser_document_id, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) {</span>
<span class="s2">                count(uid)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">AdviserRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">adviser_document_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Integrity error - multiple adviser runs found for the &quot;</span>
                <span class="n">f</span><span class="s2">&quot;same adviser document id: </span><span class="si">{adviser_document_id}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.analysis_records_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.analysis_records_exist">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_records_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether the given analysis document records exist in the graph database.&quot;&quot;&quot;</span>
        <span class="n">analysis_document_id</span> <span class="o">=</span> <span class="n">AnalysisResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">analysis_document</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        {</span>
<span class="sd">            f(func: has(%s)) @filter(eq(analysis_datetime, &quot;%s&quot;) &quot;&quot;&quot;</span>
            <span class="sd">&quot;&quot;&quot;AND eq(analysis_document_id, &quot;%s&quot;) AND eq(package_extract_name, %s) &quot;&quot;&quot;</span>
            <span class="sd">&quot;&quot;&quot;AND eq(package_extract_version, %s)) {</span>
<span class="sd">                count(uid)</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">PackageExtractRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
                <span class="n">analysis_document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
                <span class="n">analysis_document_id</span><span class="p">,</span>
                <span class="n">analysis_document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer&quot;</span><span class="p">],</span>
                <span class="n">analysis_document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer_version&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.analysis_document_id_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.analysis_document_id_exist">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_document_id_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if there is an analysis document record with the given id.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(analysis_document_id, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) {</span>
<span class="s2">                count(uid)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PackageExtractRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">analysis_document_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Integrity error - multiple package-extract runs found for the &quot;</span>
                <span class="n">f</span><span class="s2">&quot;same image analysis document id: </span><span class="si">{analysis_document_id}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.inspection_document_id_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.inspection_document_id_exist">[docs]</a>    <span class="k">def</span> <span class="nf">inspection_document_id_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inspection_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if there is an inspection document record with the given id.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(inspection_document_id, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) {</span>
<span class="s2">                count(uid)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">InspectionRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">inspection_document_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Integrity error - multiple inspection runs found for the &quot;</span>
                <span class="n">f</span><span class="s2">&quot;same inspection document id: </span><span class="si">{inspection_document_id}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.provenance_checker_document_id_exist"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.provenance_checker_document_id_exist">[docs]</a>    <span class="k">def</span> <span class="nf">provenance_checker_document_id_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provenance_checker_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if there is a provenance-checker document record with the given id.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(provenance_checker_document_id, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) {</span>
<span class="s2">                count(uid)</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ProvenanceCheckerRun</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">provenance_checker_document_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Integrity error - multiple provenance checker runs found for the &quot;</span>
                <span class="n">f</span><span class="s2">&quot;same provenance checker document id: </span><span class="si">{provenance_checker_document_id}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GraphDatabase.get_python_cve_records"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_python_cve_records">[docs]</a>    <span class="k">def</span> <span class="nf">get_python_cve_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get known vulnerabilities for the given package-version.&quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(ecosystem, &quot;python&quot;) &quot;&quot;&quot;</span> \
        <span class="sd">&quot;&quot;&quot;AND eq(package_name, &quot;%s&quot;) AND eq(package_version, &quot;%s&quot;)) {</span>
<span class="sd">                v: has_vulnerability {</span>
<span class="sd">                    %s</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersionEntity</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CVE</span><span class="o">.</span><span class="n">get_properties</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">])))</span></div>

<div class="viewcode-block" id="GraphDatabase.get_python_package_version_hashes_sha256"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_python_package_version_hashes_sha256">[docs]</a>    <span class="k">def</span> <span class="nf">get_python_package_version_hashes_sha256</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get hashes for a Python package in specified version.&quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
        <span class="c1"># TODO: we should consider os name, os version and other properties to have this matching for the given env</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(ecosystem, &quot;python&quot;) AND eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) &quot;&quot;&quot;</span> \
        <span class="sd">&quot;&quot;&quot;AND eq(package_version, &quot;%s&quot;) AND eq(index_url, &quot;%s&quot;)) {</span>
<span class="sd">                a: has_artifact {</span>
<span class="sd">                    artifact_hash_sha256</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">,</span>
            <span class="n">index_url</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span>

        <span class="c1"># Join resulting arrays.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">artifact_record</span> <span class="ow">in</span> <span class="n">query_result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">artifact_record</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;artifact_hash_sha256&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GraphDatabase.get_all_python_package_version_hashes_sha256"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_all_python_package_version_hashes_sha256">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_python_package_version_hashes_sha256</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get hashes for a Python package per index.&quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>

        <span class="c1"># The query requires @cascade to filter out the nodes which</span>
        <span class="c1"># has index url but not artifact for that package/version</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span>
<span class="s2">            f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(package_name, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(package_version, &quot;</span><span class="si">%s</span><span class="s2">&quot;)) @cascade{</span>
<span class="s2">                index_url</span>
<span class="s2">                </span><span class="si">%s</span><span class="s2"> {</span>
<span class="s2">                    artifact_hash_sha256</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">,</span>
            <span class="n">HasArtifact</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[[</span><span class="n">hashes</span><span class="p">[</span><span class="s2">&quot;index_url&quot;</span><span class="p">],</span> <span class="n">hashes</span><span class="p">[</span><span class="s2">&quot;has_artifact&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;artifact_hash_sha256&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">hashes</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]]</span></div>

<div class="viewcode-block" id="GraphDatabase.register_python_package_index"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.register_python_package_index">[docs]</a>    <span class="k">def</span> <span class="nf">register_python_package_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">warehouse_api_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register the given Python package index in the graph database.&quot;&quot;&quot;</span>
        <span class="n">existed</span> <span class="o">=</span> <span class="n">PythonPackageIndex</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">warehouse_api_url</span><span class="o">=</span><span class="n">warehouse_api_url</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">existed</span></div>

<div class="viewcode-block" id="GraphDatabase.python_package_index_listing"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.python_package_index_listing">[docs]</a>    <span class="k">def</span> <span class="nf">python_package_index_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get listing of Python package indexes registered in the graph database database.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        {</span>
<span class="sd">            f(func: has(%s)) {</span>
<span class="sd">                url</span>
<span class="sd">                warehouse_api_url</span>
<span class="sd">                verify_ssl</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">PythonPackageIndex</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># State explicitly warehouse API url is None if no was configured.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;warehouse_api_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s2">&quot;warehouse_api_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GraphDatabase.get_python_package_index_urls"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_python_package_index_urls">[docs]</a>    <span class="k">def</span> <span class="nf">get_python_package_index_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve all the URLs of registered Python package indexes.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        {</span>
<span class="sd">            f(func: has(%s)) {</span>
<span class="sd">                u: url</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">PythonPackageIndex</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="GraphDatabase.get_python_packages_for_index"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_python_packages_for_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_python_packages_for_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve listing of Python packages known to graph database instance for the given index.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            {</span>
<span class="s2">                f(func: has(</span><span class="si">%s</span><span class="s2">)) @filter(eq(index_url, &quot;</span><span class="si">%s</span><span class="s2">&quot;) AND eq(ecosystem, python)) {</span>
<span class="s2">                    package_name</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
            <span class="n">index_url</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">python_package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">python_package</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]])</span></div>

<div class="viewcode-block" id="GraphDatabase.get_python_packages"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_python_packages">[docs]</a>    <span class="k">def</span> <span class="nf">get_python_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve listing of all Python packages known to graph database instance.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            {</span>
<span class="sd">                f(func: has(%s)) @filter(eq(ecosystem, python)) {</span>
<span class="sd">                    package_name</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">python_package</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">python_package</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]])</span></div>

    <span class="k">def</span> <span class="nf">_python_packages_create_stack</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">python_package_versions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">PythonPackageVersion</span><span class="p">],</span> <span class="n">software_stack</span><span class="p">:</span> <span class="n">SoftwareStackBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assign the given set of packages to the stack.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">python_package_version</span> <span class="ow">in</span> <span class="n">python_package_versions</span><span class="p">:</span>
            <span class="n">CreatesStack</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">software_stack</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_python_package_record</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">python_package_version</span><span class="p">:</span> <span class="n">PythonPackageVersion</span><span class="p">,</span> <span class="n">verify_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a record for the given Python package.</span>

<span class="sd">        @raises PythonIndexNotRegistered: if there is no index registered from which the Python version came.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">python_package_version</span><span class="o">.</span><span class="n">uid</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;The given Python package has been already synced into graph database&quot;</span>

        <span class="n">package_index</span> <span class="o">=</span> <span class="n">PythonPackageIndex</span><span class="o">.</span><span class="n">query_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">python_package_version</span><span class="o">.</span><span class="n">index_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verify_index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">package_index</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PythonIndexNotRegistered</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Python package index for </span><span class="si">{python_package_version.index_url}</span><span class="s2"> not registered, &quot;</span>
                <span class="n">f</span><span class="s2">&quot;cannot insert package {python_package_version.to_dict()}&quot;</span>
            <span class="p">)</span>

        <span class="n">existed</span> <span class="o">=</span> <span class="n">python_package_version</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">existed</span><span class="p">:</span>
            <span class="n">entity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_package_version_entity</span><span class="p">(</span>
                <span class="n">python_package_version</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span>
                <span class="n">python_package_version</span><span class="o">.</span><span class="n">package_version</span><span class="p">,</span>
                <span class="n">python_package_version</span><span class="o">.</span><span class="n">index_url</span>
            <span class="p">)</span>

            <span class="n">InstalledFrom</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">package_index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">existed</span><span class="p">:</span>
                <span class="n">ProvidedBy</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">package_index</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<div class="viewcode-block" id="GraphDatabase.create_python_package_version_entity"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create_python_package_version_entity">[docs]</a>    <span class="k">def</span> <span class="nf">create_python_package_version_entity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">only_if_package_seen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">PythonPackageVersionEntity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Create a Python package version entity in the graph database.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">only_if_package_seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_package_exists</span><span class="p">(</span><span class="n">package_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">entity</span> <span class="o">=</span> <span class="n">PythonPackageVersionEntity</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
            <span class="n">package_name</span><span class="o">=</span><span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="o">=</span><span class="n">package_version</span><span class="p">,</span>
            <span class="n">index_url</span><span class="o">=</span><span class="n">index_url</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">existed</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">entity</span><span class="p">,</span> <span class="n">existed</span></div>

<div class="viewcode-block" id="GraphDatabase.create_python_packages_pipfile"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create_python_packages_pipfile">[docs]</a>    <span class="k">def</span> <span class="nf">create_python_packages_pipfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pipfile_locked</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">run_software_environment</span><span class="p">:</span> <span class="n">UserRunSoftwareEnvironmentModel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PythonPackageVersion</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create Python packages from Pipfile.lock entries and return them.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pipfile_locked</span> <span class="o">=</span> <span class="n">PipfileLock</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">pipfile_locked</span><span class="p">,</span> <span class="n">pipfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">pipfile_locked</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">python_package_version</span> <span class="o">=</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">locked_version</span><span class="p">,</span>
                <span class="n">index_url</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">extras</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">run_software_environment</span><span class="o">.</span><span class="n">os_name</span> <span class="k">if</span> <span class="n">run_software_environment</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">run_software_environment</span><span class="o">.</span><span class="n">os_version</span> <span class="k">if</span> <span class="n">run_software_environment</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">run_software_environment</span><span class="o">.</span><span class="n">python_version</span> <span class="k">if</span> <span class="n">run_software_environment</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="c1"># We assume these to be false as these are inputs or recommendation output.</span>
                <span class="n">solver_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unparseable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unsolvable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_python_package_record</span><span class="p">(</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">verify_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">python_package_version</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GraphDatabase.create_user_software_stack_pipfile"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create_user_software_stack_pipfile">[docs]</a>    <span class="k">def</span> <span class="nf">create_user_software_stack_pipfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">adviser_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pipfile_locked</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">run_software_environment</span><span class="p">:</span> <span class="n">UserRunSoftwareEnvironmentModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserSoftwareStack</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a user software stack entry from Pipfile.lock.&quot;&quot;&quot;</span>
        <span class="n">python_package_versions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_packages_pipfile</span><span class="p">(</span><span class="n">pipfile_locked</span><span class="p">,</span> <span class="n">run_software_environment</span><span class="p">)</span>
        <span class="n">software_stack</span> <span class="o">=</span> <span class="n">UserSoftwareStack</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">document_id</span><span class="o">=</span><span class="n">adviser_document_id</span><span class="p">)</span>
        <span class="n">software_stack</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_packages_create_stack</span><span class="p">(</span><span class="n">python_package_versions</span><span class="p">,</span> <span class="n">software_stack</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">software_stack</span></div>

<div class="viewcode-block" id="GraphDatabase.create_python_package_requirement"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create_python_package_requirement">[docs]</a>    <span class="k">def</span> <span class="nf">create_python_package_requirement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requirements</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PythonPackageRequirement</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create requirements for un-pinned Python packages.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pipfile</span> <span class="o">=</span> <span class="n">Pipfile</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="n">pipfile</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">python_package_requirement</span> <span class="o">=</span> <span class="n">PythonPackageRequirement</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">requirement</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">version_range</span><span class="o">=</span><span class="n">requirement</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">index_url</span><span class="o">=</span><span class="n">requirement</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">url</span> <span class="k">if</span> <span class="n">requirement</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">markers</span><span class="o">=</span><span class="n">requirement</span><span class="o">.</span><span class="n">markers</span><span class="p">,</span>
                <span class="n">develop</span><span class="o">=</span><span class="n">requirement</span><span class="o">.</span><span class="n">develop</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">python_package_requirement</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">python_package_requirement</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GraphDatabase.create_inspection_software_stack_pipfile"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create_inspection_software_stack_pipfile">[docs]</a>    <span class="k">def</span> <span class="nf">create_inspection_software_stack_pipfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pipfile_locked</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InspectionSoftwareStack</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an inspection software stack entry from Pipfile.lock.&quot;&quot;&quot;</span>
        <span class="n">python_package_versions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_packages_pipfile</span><span class="p">(</span><span class="n">pipfile_locked</span><span class="p">)</span>
        <span class="n">software_stack</span> <span class="o">=</span> <span class="n">InspectionSoftwareStack</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">inspection_document_id</span><span class="o">=</span><span class="n">document_id</span><span class="p">)</span>
        <span class="n">software_stack</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_packages_create_stack</span><span class="p">(</span><span class="n">python_package_versions</span><span class="p">,</span> <span class="n">software_stack</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">software_stack</span></div>

<div class="viewcode-block" id="GraphDatabase.create_advised_software_stack_pipfile"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create_advised_software_stack_pipfile">[docs]</a>    <span class="k">def</span> <span class="nf">create_advised_software_stack_pipfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">adviser_document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pipfile_locked</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">advised_stack_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">performance_score</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">overall_score</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">run_software_environment</span><span class="p">:</span> <span class="n">UserRunSoftwareEnvironmentModel</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdvisedSoftwareStack</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an advised software stack entry from Pipfile.lock.&quot;&quot;&quot;</span>
        <span class="n">python_package_versions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_packages_pipfile</span><span class="p">(</span><span class="n">pipfile_locked</span><span class="p">,</span> <span class="n">run_software_environment</span><span class="p">)</span>
        <span class="n">software_stack</span> <span class="o">=</span> <span class="n">AdvisedSoftwareStack</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">adviser_document_id</span><span class="o">=</span><span class="n">adviser_document_id</span><span class="p">,</span>
            <span class="n">advised_stack_index</span><span class="o">=</span><span class="n">advised_stack_index</span><span class="p">,</span>
            <span class="n">performance_score</span><span class="o">=</span><span class="n">performance_score</span><span class="p">,</span>
            <span class="n">overall_score</span><span class="o">=</span><span class="n">overall_score</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">software_stack</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_packages_create_stack</span><span class="p">(</span><span class="n">python_package_versions</span><span class="p">,</span> <span class="n">software_stack</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">software_stack</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_hardware_information</span><span class="p">(</span><span class="n">specs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HardwareInformationModel</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get hardware information based on requests provided.&quot;&quot;&quot;</span>
        <span class="n">hardware</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hardware&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">ram_size</span> <span class="o">=</span> <span class="n">OpenShift</span><span class="o">.</span><span class="n">parse_memory_spec</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;memory&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ram_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Convert bytes to GiB, we need float number for Dgraph serialization</span>
            <span class="n">ram_size</span> <span class="o">=</span> <span class="n">ram_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">HardwareInformationModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">cpu_family</span><span class="o">=</span><span class="n">hardware</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu_family&quot;</span><span class="p">),</span>
            <span class="n">cpu_model</span><span class="o">=</span><span class="n">hardware</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu_model&quot;</span><span class="p">),</span>
            <span class="n">cpu_physical_cpus</span><span class="o">=</span><span class="n">hardware</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;physical_cpus&quot;</span><span class="p">),</span>
            <span class="n">cpu_model_name</span><span class="o">=</span><span class="n">hardware</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processor&quot;</span><span class="p">),</span>
            <span class="n">cpu_cores</span><span class="o">=</span><span class="n">OpenShift</span><span class="o">.</span><span class="n">parse_cpu_spec</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">specs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ram_size</span><span class="o">=</span><span class="n">ram_size</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="GraphDatabase.sync_inspection_result"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.sync_inspection_result">[docs]</a>    <span class="nd">@enable_vertex_cache</span>
    <span class="k">def</span> <span class="nf">sync_inspection_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync the given inspection document into the graph database.&quot;&quot;&quot;</span>
        <span class="c1"># Check if we have such performance model before creating any other records.</span>
        <span class="n">performance_indicator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">):</span>  <span class="c1"># We have run an inspection job.</span>
            <span class="n">performance_indicator_name</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;job_log&quot;</span><span class="p">][</span><span class="s2">&quot;stdout&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">performance_model_class</span> <span class="o">=</span> <span class="n">PERFORMANCE_MODEL_BY_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">performance_indicator_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">performance_model_class</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PerformanceIndicatorNotRegistered</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;No performance indicator registered for name </span><span class="si">{performance_indicator_name!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">performance_indicator</span> <span class="o">=</span> <span class="n">performance_model_class</span><span class="o">.</span><span class="n">create_from_report</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
            <span class="n">performance_indicator</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">build_cpu</span> <span class="o">=</span> <span class="n">OpenShift</span><span class="o">.</span><span class="n">parse_cpu_spec</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;build&quot;</span><span class="p">][</span><span class="s2">&quot;requests&quot;</span><span class="p">][</span><span class="s2">&quot;cpu&quot;</span><span class="p">])</span>
        <span class="n">build_memory</span> <span class="o">=</span> <span class="n">OpenShift</span><span class="o">.</span><span class="n">parse_memory_spec</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;build&quot;</span><span class="p">][</span><span class="s2">&quot;requests&quot;</span><span class="p">][</span><span class="s2">&quot;memory&quot;</span><span class="p">])</span>
        <span class="n">run_cpu</span> <span class="o">=</span> <span class="n">OpenShift</span><span class="o">.</span><span class="n">parse_cpu_spec</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;run&quot;</span><span class="p">][</span><span class="s2">&quot;requests&quot;</span><span class="p">][</span><span class="s2">&quot;cpu&quot;</span><span class="p">])</span>
        <span class="n">run_memory</span> <span class="o">=</span> <span class="n">OpenShift</span><span class="o">.</span><span class="n">parse_memory_spec</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;run&quot;</span><span class="p">][</span><span class="s2">&quot;requests&quot;</span><span class="p">][</span><span class="s2">&quot;memory&quot;</span><span class="p">])</span>

        <span class="c1"># Convert bytes to GiB, we need float number given the fixed int size.</span>
        <span class="n">run_memory</span> <span class="o">=</span> <span class="n">run_memory</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">build_memory</span> <span class="o">=</span> <span class="n">build_memory</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">inspection_document_id</span> <span class="o">=</span> <span class="n">InspectionResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">inspection_run</span> <span class="o">=</span> <span class="n">InspectionRun</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">inspection_document_id</span><span class="o">=</span><span class="n">inspection_document_id</span><span class="p">,</span>
            <span class="n">inspection_datetime</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">),</span>
            <span class="n">amun_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># TODO: propagate Amun version here which should match API version</span>
            <span class="n">build_requests_cpu</span><span class="o">=</span><span class="n">build_cpu</span><span class="p">,</span>
            <span class="n">build_requests_memory</span><span class="o">=</span><span class="n">build_memory</span><span class="p">,</span>
            <span class="n">run_requests_cpu</span><span class="o">=</span><span class="n">run_cpu</span><span class="p">,</span>
            <span class="n">run_requests_memory</span><span class="o">=</span><span class="n">run_memory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inspection_run</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;python&quot;</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">]:</span>
            <span class="n">inspection_software_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_inspection_software_stack_pipfile</span><span class="p">(</span>
                <span class="n">inspection_document_id</span><span class="p">,</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;python&quot;</span><span class="p">][</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">InspectionStackInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">inspection_software_stack</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">inspection_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

        <span class="c1"># We query for an existing analysis of image for build and run, if it did not exist, we create</span>
        <span class="c1"># a placeholder which will be used in package-extract sync.</span>
        <span class="n">build_software_environment</span> <span class="o">=</span> <span class="n">BuildSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">query_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">environment_name</span><span class="o">=</span><span class="n">inspection_document_id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">build_software_environment</span><span class="p">:</span>
            <span class="c1"># TODO: we will need to use fully-qualified images in inspection runs as base.</span>
            <span class="n">build_software_environment</span> <span class="o">=</span> <span class="n">BuildSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">environment_name</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;base&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">build_software_environment</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">InspectionBuildSoftwareEnvironmentInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">build_software_environment</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">inspection_run</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">RunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">query_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">environment_name</span><span class="o">=</span><span class="n">inspection_document_id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">run_software_environment</span><span class="p">:</span>
            <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">RunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">environment_name</span><span class="o">=</span><span class="n">inspection_document_id</span>
            <span class="p">)</span>
            <span class="n">run_software_environment</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">InspectionRunSoftwareEnvironmentInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">run_software_environment</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">inspection_run</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">hardware</span> <span class="o">=</span> <span class="n">HardwareInformationConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;build&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hardware&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="p">)</span>
        <span class="n">hardware_information_build</span> <span class="o">=</span> <span class="n">HardwareInformationModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="o">**</span><span class="n">hardware</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="n">hardware_information_build</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="n">UsedInBuild</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">hardware_information_build</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">inspection_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">):</span>  <span class="c1"># We have run an inspection job.</span>
            <span class="n">hardware</span> <span class="o">=</span> <span class="n">HardwareInformationConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">document</span><span class="p">[</span><span class="s2">&quot;specification&quot;</span><span class="p">][</span><span class="s2">&quot;run&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hardware&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="p">)</span>
            <span class="n">hardware_information_job</span> <span class="o">=</span> <span class="n">HardwareInformationModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="o">**</span><span class="n">hardware</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
            <span class="n">hardware_information_job</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
            <span class="n">UsedInJob</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">hardware_information_job</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">inspection_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

            <span class="n">ObservedPerformance</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">inspection_run</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">performance_indicator</span><span class="p">,</span>
                <span class="n">performance_indicator_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># We can now run only one pi per inspection request.</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.create_python_cve_record"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.create_python_cve_record">[docs]</a>    <span class="k">def</span> <span class="nf">create_python_cve_record</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">package_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">record_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">version_range</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">advisory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cve</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">CVE</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Store information about a CVE in the graph database for the given Python package.&quot;&quot;&quot;</span>
        <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
        <span class="n">python_index</span> <span class="o">=</span> <span class="n">PythonPackageIndex</span><span class="o">.</span><span class="n">query_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">index_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">python_index</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PythonIndexNotRegistered</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Cannot insert CVE record into database, no Python index with url </span><span class="si">{index_url}</span><span class="s2"> registered&quot;</span>
            <span class="p">)</span>

        <span class="n">entity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_package_version_entity</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="n">package_version</span><span class="p">,</span> <span class="n">index_url</span><span class="p">)</span>
        <span class="n">ProvidedBy</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_index</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">cve_record</span> <span class="o">=</span> <span class="n">CVE</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">cve_id</span><span class="o">=</span><span class="n">record_id</span><span class="p">,</span> <span class="n">version_range</span><span class="o">=</span><span class="n">version_range</span><span class="p">,</span> <span class="n">advisory</span><span class="o">=</span><span class="n">advisory</span><span class="p">,</span> <span class="n">cve_name</span><span class="o">=</span><span class="n">cve</span><span class="p">)</span>
        <span class="n">cve_record_existed</span> <span class="o">=</span> <span class="n">cve_record</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CVE record wit id </span><span class="si">%r</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">record_id</span><span class="p">,</span> <span class="s2">&quot;added&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cve_record_existed</span> <span class="k">else</span> <span class="s2">&quot;was already present&quot;</span><span class="p">)</span>

        <span class="n">has_vulnerability</span> <span class="o">=</span> <span class="n">HasVulnerability</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">cve_record</span><span class="p">)</span>
        <span class="n">has_vulnerability_existed</span> <span class="o">=</span> <span class="n">has_vulnerability</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;CVE record </span><span class="si">%r</span><span class="s2"> for vulnerability of </span><span class="si">%r</span><span class="s2"> in version </span><span class="si">%r</span><span class="s2"> &quot;</span><span class="p">,</span>
            <span class="n">record_id</span><span class="p">,</span>
            <span class="n">package_name</span><span class="p">,</span>
            <span class="n">package_version</span><span class="p">,</span>
            <span class="s2">&quot;added&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">has_vulnerability_existed</span> <span class="k">else</span> <span class="s2">&quot;was already present&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">cve_record</span><span class="p">,</span> <span class="n">has_vulnerability_existed</span></div>

    <span class="k">def</span> <span class="nf">_deb_sync_analysis_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_extract_run</span><span class="p">:</span> <span class="n">PackageExtractRun</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync results of deb packages found in the given container image.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">deb_package_info</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;deb-dependencies&quot;</span><span class="p">]:</span>
            <span class="n">deb_package_version</span> <span class="o">=</span> <span class="n">DebPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;deb&quot;</span><span class="p">,</span>
                <span class="n">package_name</span><span class="o">=</span><span class="n">deb_package_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">deb_package_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
                <span class="n">epoch</span><span class="o">=</span><span class="n">deb_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">),</span>
                <span class="n">arch</span><span class="o">=</span><span class="n">deb_package_info</span><span class="p">[</span><span class="s2">&quot;arch&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">deb_package_version</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
            <span class="n">Identified</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">package_extract_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">deb_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

            <span class="c1"># These three can be grouped with a zip, but that is not that readable...</span>
            <span class="k">for</span> <span class="n">pre_depends</span> <span class="ow">in</span> <span class="n">deb_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pre-depends&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">deb_dependency</span> <span class="o">=</span> <span class="n">DebDependency</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;deb&quot;</span><span class="p">,</span> <span class="n">package_name</span><span class="o">=</span><span class="n">pre_depends</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">deb_dependency</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

                <span class="n">DebPreDepends</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">deb_package_version</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">deb_dependency</span><span class="p">,</span> <span class="n">version_range</span><span class="o">=</span><span class="n">pre_depends</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">depends</span> <span class="ow">in</span> <span class="n">deb_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;depends&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">deb_dependency</span> <span class="o">=</span> <span class="n">DebDependency</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;deb&quot;</span><span class="p">,</span> <span class="n">package_name</span><span class="o">=</span><span class="n">depends</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">deb_dependency</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

                <span class="n">DebDepends</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">deb_package_version</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">deb_dependency</span><span class="p">,</span> <span class="n">version_range</span><span class="o">=</span><span class="n">depends</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">replaces</span> <span class="ow">in</span> <span class="n">deb_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;replaces&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">deb_dependency</span> <span class="o">=</span> <span class="n">DebDependency</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;deb&quot;</span><span class="p">,</span> <span class="n">package_name</span><span class="o">=</span><span class="n">replaces</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">deb_dependency</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

                <span class="n">DebReplaces</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">deb_package_version</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">deb_dependency</span><span class="p">,</span> <span class="n">version_range</span><span class="o">=</span><span class="n">replaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rpm_sync_analysis_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_extract_run</span><span class="p">:</span> <span class="n">PackageExtractRun</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync results of RPMs found in the given container image.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rpm_package_info</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;rpm-dependencies&quot;</span><span class="p">]:</span>
            <span class="n">rpm_package_version</span> <span class="o">=</span> <span class="n">RPMPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;rpm&quot;</span><span class="p">,</span>
                <span class="n">package_name</span><span class="o">=</span><span class="n">rpm_package_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">rpm_package_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
                <span class="n">release</span><span class="o">=</span><span class="n">rpm_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;release&quot;</span><span class="p">),</span>
                <span class="n">epoch</span><span class="o">=</span><span class="n">rpm_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">),</span>
                <span class="n">arch</span><span class="o">=</span><span class="n">rpm_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arch&quot;</span><span class="p">),</span>
                <span class="n">src</span><span class="o">=</span><span class="n">rpm_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">package_identifier</span><span class="o">=</span><span class="n">rpm_package_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_identifier&quot;</span><span class="p">,</span> <span class="n">rpm_package_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">rpm_package_version</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

            <span class="n">Identified</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">package_extract_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">rpm_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">rpm_package_info</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]:</span>
                <span class="n">rpm_requirement</span> <span class="o">=</span> <span class="n">RPMRequirement</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">rpm_requirement_name</span><span class="o">=</span><span class="n">dependency</span><span class="p">)</span>
                <span class="n">rpm_requirement</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

                <span class="n">Requires</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">rpm_package_version</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">rpm_requirement</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_python_sync_analysis_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">package_extract_run</span><span class="p">:</span> <span class="n">PackageExtractRun</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">EnvironmentBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync results of Python packages found in the given container image.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">python_package_info</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;mercator&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;ecosystem&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Python-RequirementsTXT&quot;</span><span class="p">:</span>
                <span class="c1"># We don&#39;t want to sync found requirement.txt artifacts as</span>
                <span class="c1"># they do not carry any valuable information for us.</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="s2">&quot;result&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">python_package_info</span> <span class="ow">or</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]:</span>
                <span class="c1"># Mercator was unable to process this - e.g. there was a</span>
                <span class="c1"># setup.py that is not distutils setup.py</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping error entry - </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">python_package_info</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                <span class="n">analysis_document_id</span> <span class="o">=</span> <span class="n">AnalysisResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No package name found in entry </span><span class="si">%r</span><span class="s2"> when syncing document </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">python_package_info</span><span class="p">,</span>
                    <span class="n">analysis_document_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">python_package_version</span> <span class="o">=</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
                <span class="n">index_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">extras</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">environment</span><span class="o">.</span><span class="n">os_name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">environment</span><span class="o">.</span><span class="n">os_version</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">environment</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">solver_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unparseable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unsolvable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_python_package_record</span><span class="p">(</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">verify_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">Identified</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">package_extract_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_python_file_digests_sync_analysis_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_extract_run</span><span class="p">:</span> <span class="n">PackageExtractRun</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync results of Python files found in the given container image.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;python&quot;</span><span class="p">]:</span>
            <span class="n">python_file_digests</span> <span class="o">=</span> <span class="n">PythonFileDigest</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">sha256</span><span class="o">=</span><span class="n">py_file</span><span class="p">[</span><span class="s2">&quot;sha256&quot;</span><span class="p">])</span>
            <span class="n">python_file_digests</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
            <span class="n">FoundFile</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">package_extract_run</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">python_file_digests</span><span class="p">,</span>
                <span class="n">file_path</span><span class="o">=</span><span class="n">py_file</span><span class="p">[</span><span class="s2">&quot;filepath&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

<div class="viewcode-block" id="GraphDatabase.sync_analysis_result"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.sync_analysis_result">[docs]</a>    <span class="nd">@enable_vertex_cache</span>
    <span class="k">def</span> <span class="nf">sync_analysis_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync the given analysis result to the graph database.&quot;&quot;&quot;</span>
        <span class="n">analysis_document_id</span> <span class="o">=</span> <span class="n">AnalysisResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">environment_type</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;thoth-package-extract&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;environment_type&quot;</span><span class="p">]</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;thoth-package-extract&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span>
        <span class="n">environment_name</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;extract-image&quot;</span><span class="p">][</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>

        <span class="n">image_tag</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span>
        <span class="n">image_name</span> <span class="o">=</span> <span class="n">environment_name</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">environment_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">image_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">image_tag</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># TODO: capture errors on image analysis? result of package-extract should be a JSON with error flag</span>
        <span class="n">package_extract_run</span> <span class="o">=</span> <span class="n">PackageExtractRun</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">analysis_document_id</span><span class="o">=</span><span class="n">analysis_document_id</span><span class="p">,</span>
            <span class="n">analysis_datetime</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
            <span class="n">package_extract_version</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer_version&quot;</span><span class="p">],</span>
            <span class="n">package_extract_name</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer&quot;</span><span class="p">],</span>
            <span class="n">environment_type</span><span class="o">=</span><span class="n">environment_type</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;thoth-package-extract&quot;</span><span class="p">][</span><span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
            <span class="n">package_extract_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">image_tag</span><span class="o">=</span><span class="n">image_tag</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># TODO: assign duration</span>
            <span class="n">os_id</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operating-system&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
            <span class="n">os_name</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operating-system&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
            <span class="n">os_version_id</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operating-system&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_id&quot;</span><span class="p">),</span>

        <span class="p">)</span>
        <span class="n">package_extract_run</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">environment_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;environment_name&quot;</span><span class="p">:</span> <span class="n">environment_name</span><span class="p">,</span>
            <span class="c1"># TODO: find Python version which would be used by default</span>
            <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;image_name&quot;</span><span class="p">:</span> <span class="n">image_name</span><span class="p">,</span>
            <span class="s2">&quot;image_sha&quot;</span><span class="p">:</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;os_name&quot;</span><span class="p">:</span> <span class="n">package_extract_run</span><span class="o">.</span><span class="n">os_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">package_extract_run</span><span class="o">.</span><span class="n">os_name</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;os_version&quot;</span><span class="p">:</span> <span class="n">package_extract_run</span><span class="o">.</span><span class="n">os_version_id</span><span class="p">,</span>
            <span class="c1"># TODO: assign CUDA</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">environment_type</span> <span class="o">==</span> <span class="s2">&quot;runtime&quot;</span><span class="p">:</span>
            <span class="n">environment_class</span> <span class="o">=</span> <span class="n">RunSoftwareEnvironmentModel</span>
        <span class="k">elif</span> <span class="n">environment_type</span> <span class="o">==</span> <span class="s2">&quot;buildtime&quot;</span><span class="p">:</span>
            <span class="n">environment_class</span> <span class="o">=</span> <span class="n">BuildSoftwareEnvironmentModel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown environment type </span><span class="si">%r</span><span class="s2">, should be &#39;buildtime&#39; or &#39;runtime&#39;&quot;</span> <span class="o">%</span> <span class="n">environment_type</span><span class="p">)</span>

        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment_class</span><span class="o">.</span><span class="n">query_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">environment_name</span><span class="o">=</span><span class="n">environment_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">environment</span><span class="p">:</span>
            <span class="n">environment</span> <span class="o">=</span> <span class="n">environment_class</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="o">**</span><span class="n">environment_parameters</span><span class="p">)</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">AnalyzedBy</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">environment</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">package_extract_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rpm_sync_analysis_result</span><span class="p">(</span><span class="n">package_extract_run</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deb_sync_analysis_result</span><span class="p">(</span><span class="n">package_extract_run</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_sync_analysis_result</span><span class="p">(</span><span class="n">package_extract_run</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_file_digests_sync_analysis_result</span><span class="p">(</span><span class="n">package_extract_run</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.sync_solver_result"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.sync_solver_result">[docs]</a>    <span class="nd">@enable_vertex_cache</span>
    <span class="k">def</span> <span class="nf">sync_solver_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync the given solver result to the graph database.&quot;&quot;&quot;</span>
        <span class="n">solver_document_id</span> <span class="o">=</span> <span class="n">SolverResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">solver_name</span> <span class="o">=</span> <span class="n">SolverResultsStore</span><span class="o">.</span><span class="n">get_solver_name_from_document_id</span><span class="p">(</span><span class="n">solver_document_id</span><span class="p">)</span>
        <span class="n">solver_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_python_solver_name</span><span class="p">(</span><span class="n">solver_name</span><span class="p">)</span>
        <span class="n">solver_datetime</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
        <span class="n">solver_version</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer_version&quot;</span><span class="p">]</span>
        <span class="n">os_name</span> <span class="o">=</span> <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_name&quot;</span><span class="p">]</span>
        <span class="n">os_version</span> <span class="o">=</span> <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;os_version&quot;</span><span class="p">]</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="n">solver_info</span><span class="p">[</span><span class="s2">&quot;python_version&quot;</span><span class="p">]</span>

        <span class="n">ecosystem_solver_run</span> <span class="o">=</span> <span class="n">EcosystemSolverRun</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
            <span class="n">solver_document_id</span><span class="o">=</span><span class="n">solver_document_id</span><span class="p">,</span>
            <span class="n">solver_datetime</span><span class="o">=</span><span class="n">solver_datetime</span><span class="p">,</span>
            <span class="n">solver_name</span><span class="o">=</span><span class="n">solver_name</span><span class="p">,</span>
            <span class="n">solver_version</span><span class="o">=</span><span class="n">solver_version</span><span class="p">,</span>
            <span class="n">os_name</span><span class="o">=</span><span class="n">os_name</span><span class="p">,</span>
            <span class="n">os_version</span><span class="o">=</span><span class="n">os_version</span><span class="p">,</span>
            <span class="n">python_version</span><span class="o">=</span><span class="n">python_version</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># TODO: propagate duration information</span>
        <span class="p">)</span>
        <span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">python_package_info</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;tree&quot;</span><span class="p">]:</span>
            <span class="n">package_name</span> <span class="o">=</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]</span>
            <span class="n">package_version</span> <span class="o">=</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;package_version&quot;</span><span class="p">]</span>
            <span class="n">index_url</span> <span class="o">=</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;index_url&quot;</span><span class="p">]</span>

            <span class="n">python_package_version</span> <span class="o">=</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">),</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">package_version</span><span class="p">,</span>
                <span class="n">index_url</span><span class="o">=</span><span class="n">index_url</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_version</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">solver_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unparseable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unsolvable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_python_package_record</span><span class="p">(</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">verify_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;sha256&quot;</span><span class="p">]:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;No hashes found for package </span><span class="si">{package_name}</span><span class="s2"> in version </span><span class="si">{package_version}</span><span class="s2"> from </span><span class="si">{index_url}</span><span class="s2">, &quot;</span>
                    <span class="n">f</span><span class="s2">&quot;error during syncing solver document </span><span class="si">{solver_document_id}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">digest</span> <span class="ow">in</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;sha256&quot;</span><span class="p">]:</span>
                <span class="n">python_artifact</span> <span class="o">=</span> <span class="n">PythonArtifact</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">artifact_hash_sha256</span><span class="o">=</span><span class="n">digest</span><span class="p">)</span>
                <span class="n">python_artifact</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
                <span class="n">HasArtifact</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_artifact</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
                <span class="p">)</span>

            <span class="c1"># TODO: detect and store extras</span>
            <span class="c1"># TODO: detect and store markers</span>
            <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">python_package_info</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">index_entry</span> <span class="ow">in</span> <span class="n">dependency</span><span class="p">[</span><span class="s2">&quot;resolved_versions&quot;</span><span class="p">]:</span>
                    <span class="n">dependency_index_url</span> <span class="o">=</span> <span class="n">index_entry</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
                    <span class="n">package_name</span> <span class="o">=</span> <span class="n">dependency</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">dependency_version</span> <span class="ow">in</span> <span class="n">index_entry</span><span class="p">[</span><span class="s2">&quot;versions&quot;</span><span class="p">]:</span>
                        <span class="n">python_package_dependency</span> <span class="o">=</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                            <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                            <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">),</span>
                            <span class="n">package_version</span><span class="o">=</span><span class="n">dependency_version</span><span class="p">,</span>
                            <span class="n">index_url</span><span class="o">=</span><span class="n">dependency_index_url</span><span class="p">,</span>
                            <span class="n">os_name</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_name</span><span class="p">,</span>
                            <span class="n">os_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_version</span><span class="p">,</span>
                            <span class="n">python_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                            <span class="n">solver_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">solver_error_unparseable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">solver_error_unsolvable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_create_python_package_record</span><span class="p">(</span><span class="n">python_package_dependency</span><span class="p">,</span> <span class="n">verify_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">Solved</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                            <span class="n">source</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_package_dependency</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
                        <span class="n">DependsOn</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                            <span class="n">source</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">,</span>
                            <span class="n">target</span><span class="o">=</span><span class="n">python_package_dependency</span><span class="p">,</span>
                            <span class="n">version_range</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required_version&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">error_info</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;errors&quot;</span><span class="p">]:</span>
            <span class="n">package_name</span> <span class="o">=</span> <span class="n">error_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">]</span>
            <span class="n">package_version</span> <span class="o">=</span> <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
            <span class="n">index_url</span> <span class="o">=</span> <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

            <span class="n">python_package_version</span> <span class="o">=</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">ecosystem</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">),</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">package_version</span><span class="p">,</span>
                <span class="n">index_url</span><span class="o">=</span><span class="n">index_url</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_version</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">solver_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">solver_error_unparseable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unsolvable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_python_package_record</span><span class="p">(</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">verify_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">unsolvable</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;unresolved&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unsolvable</span><span class="p">[</span><span class="s2">&quot;version_spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">):</span>
                <span class="c1"># No resolution can be perfomed so no identifier is captured, report warning and continue.</span>
                <span class="c1"># We would like to capture this especially when there are</span>
                <span class="c1"># packages in ecosystem that we cannot find (e.g. not configured private index</span>
                <span class="c1"># or removed package).</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot sync unsolvable package </span><span class="si">%r</span><span class="s2"> as package is not locked to as specific version&quot;</span><span class="p">,</span> <span class="n">unsolvable</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">package_name</span> <span class="o">=</span> <span class="n">unsolvable</span><span class="p">[</span><span class="s2">&quot;package_name&quot;</span><span class="p">]</span>
            <span class="n">index_url</span> <span class="o">=</span> <span class="n">unsolvable</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="n">package_version</span> <span class="o">=</span> <span class="n">unsolvable</span><span class="p">[</span><span class="s2">&quot;version_spec&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">):]</span>

            <span class="n">python_package_version</span> <span class="o">=</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">),</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">package_version</span><span class="p">,</span>
                <span class="n">index_url</span><span class="o">=</span><span class="n">index_url</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_version</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">solver_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">solver_error_unparseable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solver_error_unsolvable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_python_package_record</span><span class="p">(</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">verify_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">unparsed</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;unparsed&quot;</span><span class="p">]:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">unparsed</span><span class="p">[</span><span class="s2">&quot;requirement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># This request did not come from graph-refresh job as there is not pinned version.</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot sync unparsed package </span><span class="si">%r</span><span class="s2"> as package is not locked to as specific version&quot;</span><span class="p">,</span> <span class="n">unparsed</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">package_name</span><span class="p">,</span> <span class="n">package_version</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="n">python_package_version</span> <span class="o">=</span> <span class="n">PythonPackageVersion</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_python_package_name</span><span class="p">(</span><span class="n">package_name</span><span class="p">),</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">package_version</span><span class="p">,</span>
                <span class="n">index_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">os_version</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">solver_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">solver_error_unparseable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">solver_error_unsolvable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_python_package_record</span><span class="p">(</span><span class="n">python_package_version</span><span class="p">,</span> <span class="n">verify_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Solved</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ecosystem_solver_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">python_package_version</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_runtime_environment_conf2models</span><span class="p">(</span>
        <span class="n">runtime_properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">is_user_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">HardwareInformationModel</span><span class="p">,</span> <span class="n">RunSoftwareEnvironmentModel</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert runtime environment configuration into model representatives.&quot;&quot;&quot;</span>
        <span class="n">hardware_properties</span> <span class="o">=</span> <span class="n">runtime_properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;hardware&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">is_user_run</span><span class="p">:</span>
            <span class="n">hardware_information</span> <span class="o">=</span> <span class="n">UserHardwareInformationModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="o">**</span><span class="n">hardware_properties</span><span class="p">)</span>

            <span class="n">runtime_environment_config</span> <span class="o">=</span> <span class="n">RuntimeEnvironmentConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">runtime_properties</span><span class="p">)</span>
            <span class="c1"># We construct our own name as we do not trust user&#39;s name input (it can be basically anything).</span>
            <span class="n">run_software_environment_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;{runtime_environment_config.operating_system.name or &#39;unknown&#39;}&quot;</span>
                <span class="n">f</span><span class="s2">&quot;:{runtime_environment_config.operating_system.version or &#39;unknown&#39;}&quot;</span>
            <span class="p">)</span>

            <span class="c1"># TODO: assign image_name and image_sha once we will have this info present in Thoth&#39;s configuration file</span>
            <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">UserRunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">environment_name</span><span class="o">=</span><span class="n">run_software_environment_name</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">cuda_version</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">cuda_version</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">hardware_information</span> <span class="o">=</span> <span class="n">HardwareInformationModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="o">**</span><span class="n">hardware_properties</span><span class="p">)</span>

            <span class="n">runtime_environment_config</span> <span class="o">=</span> <span class="n">RuntimeEnvironmentConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">runtime_properties</span><span class="p">)</span>
            <span class="c1"># We construct our own name as we do not trust user&#39;s name input (it can be basically anything).</span>
            <span class="n">run_software_environment_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;{runtime_environment_config.operating_system.name or &#39;unknown&#39;}&quot;</span>
                <span class="n">f</span><span class="s2">&quot;:{runtime_environment_config.operating_system.version or &#39;unknown&#39;}&quot;</span>
            <span class="p">)</span>

            <span class="c1"># TODO: assign image_name and image_sha once we will have this info present in Thoth&#39;s configuration file</span>
            <span class="n">run_software_environment</span> <span class="o">=</span> <span class="n">RunSoftwareEnvironmentModel</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">environment_name</span><span class="o">=</span><span class="n">run_software_environment_name</span><span class="p">,</span>
                <span class="n">python_version</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
                <span class="n">os_name</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">cuda_version</span><span class="o">=</span><span class="n">runtime_environment_config</span><span class="o">.</span><span class="n">cuda_version</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">hardware_information</span><span class="p">,</span> <span class="n">run_software_environment</span>

<div class="viewcode-block" id="GraphDatabase.sync_adviser_result"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.sync_adviser_result">[docs]</a>    <span class="nd">@enable_vertex_cache</span>
    <span class="k">def</span> <span class="nf">sync_adviser_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync adviser result into graph database.&quot;&quot;&quot;</span>
        <span class="n">adviser_document_id</span> <span class="o">=</span> <span class="n">AdvisersResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">cli_arguments</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;thoth-adviser&quot;</span><span class="p">]</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">cli_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No origin stated in the adviser result </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">adviser_document_id</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>
        <span class="n">adviser_run</span> <span class="o">=</span> <span class="n">AdviserRun</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">adviser_document_id</span><span class="o">=</span><span class="n">adviser_document_id</span><span class="p">,</span>
            <span class="n">adviser_datetime</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
            <span class="n">adviser_version</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer_version&quot;</span><span class="p">],</span>
            <span class="n">adviser_name</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer&quot;</span><span class="p">],</span>
            <span class="n">count</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">],</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">cli_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">limit_latest_versions</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit_latest_versions&quot;</span><span class="p">),</span>
            <span class="n">adviser_error</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
            <span class="n">recommendation_type</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;recommendation_type&quot;</span><span class="p">],</span>
            <span class="n">requirements_format</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;requirements_format&quot;</span><span class="p">],</span>
            <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># TODO: assign duration</span>
            <span class="n">advised_configuration_changes</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;advised_configuration&quot;</span><span class="p">)),</span>
            <span class="n">additional_stack_info</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stack_info&quot;</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">adviser_run</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="c1"># Runtime Environment Information (Hardware + Software information).</span>
        <span class="n">hardware_information</span><span class="p">,</span> <span class="n">run_software_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runtime_environment_conf2models</span><span class="p">(</span>
            <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;runtime_environment&quot;</span><span class="p">],</span> <span class="n">is_user_run</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">hardware_information</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="n">run_software_environment</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">UsedIn</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">hardware_information</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">adviser_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">AdviserRunSoftwareEnvironmentInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">run_software_environment</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">adviser_run</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="c1"># Input stack.</span>
        <span class="k">if</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">]:</span>
            <span class="c1"># User provided a Pipfile.lock, we can sync it.</span>
            <span class="n">user_software_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user_software_stack_pipfile</span><span class="p">(</span>
                <span class="n">adviser_document_id</span><span class="p">,</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">],</span> <span class="n">run_software_environment</span>
            <span class="p">)</span>
            <span class="n">AdviserStackInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">user_software_stack</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">adviser_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">python_package_requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_package_requirement</span><span class="p">(</span>
            <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;requirements&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">python_package_requirement</span> <span class="ow">in</span> <span class="n">python_package_requirements</span><span class="p">:</span>
            <span class="n">RequirementsInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">python_package_requirement</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">adviser_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span>

        <span class="c1"># Output stack.</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;report&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Omitting stack as no output Pipfile.lock was provided&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># result[0] is score report</span>
            <span class="c1"># result[1][&quot;requirements&quot;] is Pipfile</span>
            <span class="c1"># result[1][&quot;requirements_locked&quot;] is Pipfile.lock</span>
            <span class="n">performance_score</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">overall_score</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="s2">&quot;performance_score&quot;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">performance_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Multiple performance score entries found in </span><span class="si">%r</span><span class="s2"> (index: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">adviser_document_id</span><span class="p">,</span> <span class="n">idx</span>
                        <span class="p">)</span>
                    <span class="n">performance_score</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;performance_score&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s2">&quot;overall_score&quot;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">overall_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Multiple overall score entries found in </span><span class="si">%r</span><span class="s2"> (index: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">adviser_document_id</span><span class="p">,</span> <span class="n">idx</span>
                        <span class="p">)</span>
                    <span class="n">overall_score</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;overall_score&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">):</span>
                <span class="n">advised_software_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_advised_software_stack_pipfile</span><span class="p">(</span>
                    <span class="n">adviser_document_id</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[],</span>
                    <span class="n">advised_stack_index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
                    <span class="n">performance_score</span><span class="o">=</span><span class="n">performance_score</span><span class="p">,</span>
                    <span class="n">overall_score</span><span class="o">=</span><span class="n">overall_score</span><span class="p">,</span>
                    <span class="n">run_software_environment</span><span class="o">=</span><span class="n">run_software_environment</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">Advised</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">adviser_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">advised_software_stack</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.sync_provenance_checker_result"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.sync_provenance_checker_result">[docs]</a>    <span class="nd">@enable_vertex_cache</span>
    <span class="k">def</span> <span class="nf">sync_provenance_checker_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync provenance checker results into graph database.&quot;&quot;&quot;</span>
        <span class="n">provenance_checker_document_id</span> <span class="o">=</span> <span class="n">ProvenanceResultsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;thoth-adviser&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No origin stated in the provenance-checker result </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">provenance_checker_document_id</span><span class="p">)</span>

        <span class="n">provenance_checker_run</span> <span class="o">=</span> <span class="n">ProvenanceCheckerRun</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">provenance_checker_document_id</span><span class="o">=</span><span class="n">provenance_checker_document_id</span><span class="p">,</span>
            <span class="n">provenance_checker_datetime</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
            <span class="n">provenance_checker_version</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer_version&quot;</span><span class="p">],</span>
            <span class="n">provenance_checker_name</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer&quot;</span><span class="p">],</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;thoth-adviser&quot;</span><span class="p">][</span><span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
            <span class="n">provenance_checker_error</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
            <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># TODO: assign duration</span>
        <span class="p">)</span>
        <span class="n">provenance_checker_run</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">user_input</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">):</span>
            <span class="c1"># We do not have any runtime information.</span>
            <span class="n">user_software_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user_software_stack_pipfile</span><span class="p">(</span>
                <span class="n">provenance_checker_document_id</span><span class="p">,</span> <span class="n">user_input</span><span class="p">[</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">ProvenanceCheckerStackInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">user_software_stack</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">provenance_checker_run</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirements&quot;</span><span class="p">):</span>
            <span class="n">python_package_requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_package_requirement</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="s2">&quot;requirements&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">python_package_requirement</span> <span class="ow">in</span> <span class="n">python_package_requirements</span><span class="p">:</span>
                <span class="n">RequirementsInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">python_package_requirement</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">provenance_checker_run</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.sync_dependency_monkey_result"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.sync_dependency_monkey_result">[docs]</a>    <span class="nd">@enable_vertex_cache</span>
    <span class="k">def</span> <span class="nf">sync_dependency_monkey_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sync reports of dependency monkey runs.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: implement</span>
        <span class="n">dependency_monkey_run</span> <span class="o">=</span> <span class="n">DependencyMonkeyRun</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">dependency_monkey_document_id</span><span class="o">=</span><span class="n">DependencyMonkeyReportsStore</span><span class="o">.</span><span class="n">get_document_id</span><span class="p">(</span><span class="n">document</span><span class="p">),</span>
            <span class="n">dependency_monkey_datetime</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
            <span class="n">dependency_monkey_name</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer&quot;</span><span class="p">],</span>
            <span class="n">dependency_monkey_version</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;analyzer_version&quot;</span><span class="p">],</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">),</span>
            <span class="n">decision</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;decision&quot;</span><span class="p">),</span>
            <span class="n">count</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">),</span>
            <span class="n">limit_latest_versions</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit_latest_versions&quot;</span><span class="p">),</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">][</span><span class="s2">&quot;thoth-adviser&quot;</span><span class="p">][</span><span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
            <span class="n">dependency_monkey_error</span><span class="o">=</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
            <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># TODO: assign duration</span>
        <span class="p">)</span>
        <span class="n">dependency_monkey_run</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">python_package_requirements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_python_package_requirement</span><span class="p">(</span>
            <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;requirements&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">python_package_requirement</span> <span class="ow">in</span> <span class="n">python_package_requirements</span><span class="p">:</span>
            <span class="n">RequirementsInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">python_package_requirement</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dependency_monkey_run</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">hardware_information</span><span class="p">,</span> <span class="n">run_software_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runtime_environment_conf2models</span><span class="p">(</span>
            <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;runtime_environment&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">hardware_information</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="n">run_software_environment</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">DependencyMonkeyRunSoftwareEnvironmentInput</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">run_software_environment</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dependency_monkey_run</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="n">UsedIn</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">hardware_information</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dependency_monkey_run</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">inspection_document_id</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]:</span>
            <span class="n">inspection_software_stack</span> <span class="o">=</span> <span class="n">InspectionSoftwareStack</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span>
                <span class="n">inspection_document_id</span><span class="o">=</span><span class="n">inspection_document_id</span>
            <span class="p">)</span>
            <span class="n">inspection_software_stack</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>

            <span class="n">Resolved</span><span class="o">.</span><span class="n">from_properties</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">dependency_monkey_run</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">inspection_software_stack</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="GraphDatabase.get_number_of_each_vertex_in_graph"><a class="viewcode-back" href="../../../../thoth.storages.graph.html#thoth.storages.graph.dgraph.GraphDatabase.get_number_of_each_vertex_in_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_each_vertex_in_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve dictionary with number of vertices per vertex label in the graph database.&quot;&quot;&quot;</span>
        <span class="n">node_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">ALL_MODELS</span> <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">VertexBase</span><span class="p">)]</span>
        <span class="n">tot_nodes_per_label</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node_label</span> <span class="ow">in</span> <span class="n">node_labels</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            {</span>
<span class="sd">                f(func: has(%s)) {</span>
<span class="sd">                    c:count(uid)</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            &quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">node_label</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
            <span class="n">tot_nodes_per_label</span><span class="p">[</span><span class="n">node_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="k">return</span> <span class="n">tot_nodes_per_label</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Thoth team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.
    </div>
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>