
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>Thoth Storages &#8212; Thoth Storages 0.73.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="/assets/storages/pygments.css" />
    <link rel="stylesheet" type="text/css" href="/assets/storages/nameko.css" />
    <script data-url_root="./" id="documentation_options" src="/assets/storages/documentation_options.js"></script>
    <script src="/assets/storages/jquery.js"></script>
    <script src="/assets/storages/underscore.js"></script>
    <script src="/assets/storages/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="thoth.storages package" href="thoth.storages.html" />

   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Lora:400' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123174547-2']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
  
  
  <div class="indexwrapper">
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="thoth.storages.html" title="thoth.storages package"
             accesskey="N">next</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">Thoth Storages 0.73.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Thoth Storages</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="thoth-storages">
<h1>Thoth Storages<a class="headerlink" href="#thoth-storages" title="Permalink to this headline">¶</a></h1>
<a class="reference external image-reference" href="https://github.com/thoth-station/storages/releases"><img alt="GitHub tag (latest by date)" src="https://img.shields.io/github/v/tag/thoth-station/storages?style=plastic" /></a>
<a class="reference external image-reference" href="https://pypi.org/project/thoth-storages"><img alt="PyPI - Module Version" src="https://img.shields.io/pypi/v/thoth-storages?style=plastic" /></a>
<a class="reference external image-reference" href="https://pypi.org/project/thoth-storages"><img alt="PyPI - License" src="https://img.shields.io/pypi/l/thoth-storages?style=plastic" /></a>
<a class="reference external image-reference" href="https://pypi.org/project/thoth-storages"><img alt="PyPI - Downloads" src="https://img.shields.io/pypi/dm/thoth-storages?style=plastic" /></a>
<p>This library provides a library called <a class="reference external" href="https://pypi.org/project/thoth-storages">thoth-storages</a> used in project <a class="reference external" href="https://thoth-station.ninja">Thoth</a>.  The library exposes core queries and methods
for <a class="reference external" href="https://www.postgresql.org/">PostgreSQL database</a> as well as adapters
for manipulating with <a class="reference external" href="https://ceph.io/">Ceph</a> via its S3 compatible API.</p>
<section id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>Pre-requisites:</p>
<ul class="simple">
<li><p>make sure you have <code class="docutils literal notranslate"><span class="pre">podman</span></code> and <code class="docutils literal notranslate"><span class="pre">podman-compose</span></code> installed. You can install those tools by running <code class="docutils literal notranslate"><span class="pre">dnf</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">podman</span> <span class="pre">podman-compose</span></code></p></li>
<li><p>make sure you are in an environment created with <code class="docutils literal notranslate"><span class="pre">pipenv</span> <span class="pre">install</span> <span class="pre">--dev</span></code></p></li>
</ul>
<p>To develop locally the first time:</p>
<ul>
<li><p>Have a pg dump that you can <a class="reference external" href="https://github.com/thoth-station/storages#automatic-backups-of-thoth-deployment">retrieve from aws s3</a></p></li>
<li><p>Get the latest PostgreSQL container image from: <a class="reference external" href="https://catalog.redhat.com/software/containers/rhel8/postgresql-13/5ffdbdef73a65398111b8362?container-tabs=gti&amp;gti-tabs=red-hat-login">https://catalog.redhat.com/software/containers/rhel8/postgresql-13/5ffdbdef73a65398111b8362?container-tabs=gti&amp;gti-tabs=red-hat-login</a></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">podman-compose</span> <span class="pre">up</span></code> to scale up pods for database and pgweb. For more detail, refer to the <a class="reference external" href="https://github.com/thoth-station/storages#running-postgresql-locally">Running PostgreSQL locally section</a></p></li>
<li><p>Run this command to sync the pg dump into the local database:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">psql -h localhost -p 5432 --username=postgres &lt; pg_dump.sql</span>
</pre></div>
</div>
</li>
</ul>
<p>Now you are ready to test new queries or <a class="reference external" href="https://github.com/thoth-station/storages#generating-migrations-and-schema-adjustment-in-deployment">create new migrations</a></p>
<p>If you already have a local database, make sure it is not outdated and rember to follow the <a class="reference external" href="https://github.com/thoth-station/storages#generating-migrations-and-schema-adjustment-in-deployment">Generating migrations and schema adjustment in deployment</a>
section before testing any changes.</p>
</section>
<section id="installation-and-usage">
<h2>Installation and Usage<a class="headerlink" href="#installation-and-usage" title="Permalink to this headline">¶</a></h2>
<p>The library can be installed via pip or Pipenv from <a class="reference external" href="https://pypi.org/project/thoth-storages">PyPI</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pipenv install thoth-storages</span>
</pre></div>
</div>
<p>The library provides a CLI that can assist you with exploring schema and data
storing:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">thoth-storages --help</span>
<span class="gp"># </span>In a cloned repo, run:
<span class="go">PYTHONPATH=. pipenv run python3 thoth-storages --help</span>
</pre></div>
</div>
<p>You can run prepared test-suite via the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pipenv install --dev</span>
<span class="go">pipenv run python3 setup.py test</span>
</pre></div>
</div>
</section>
<section id="running-postgresql-locally">
<h2>Running PostgreSQL locally<a class="headerlink" href="#running-postgresql-locally" title="Permalink to this headline">¶</a></h2>
<p>You can use <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> present in this repository to run a local
PostgreSQL instance, (make sure you installed <a class="reference external" href="https://github.com/containers/podman-compose">podman-compose</a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dnf install -y podman podman-compose
<span class="gp">$ </span><span class="c1"># Also available from PyPI: pip install podman-compose</span>
<span class="gp">$ </span>podman-compose up
</pre></div>
</div>
<p>After running the commands above, you should be able to access a local
PostgreSQL instance at <a class="reference external" href="http://localhost:5432">localhost:5432</a>. This is also
the default configuration for PostgreSQL’s adapter that connects to localhost
unless <code class="docutils literal notranslate"><span class="pre">KNOWLEDGE_GRAPH_HOST</span></code> is supplied explicitly (see also other
environment variables in the adapter constructor for more info on configuring
the connection). The default configuration uses database named <code class="docutils literal notranslate"><span class="pre">postgres</span></code>
which can be accessed using <code class="docutils literal notranslate"><span class="pre">postgres</span></code> user and <code class="docutils literal notranslate"><span class="pre">postgres</span></code> password (SSL is
disabled).</p>
<p>The provided <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> has also <a class="reference external" href="https://sosedoff.github.io/pgweb/">PGweb</a> enabled to enable data exploration using
UI. To access it visit <a class="reference external" href="http://localhost:8081">localhost:8081</a>.</p>
<p>The provided <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> does not use any volume. After you
containers restart, the content will not be available anymore.</p>
<p>You can sync your local instance using <code class="docutils literal notranslate"><span class="pre">pgsql</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>psql -h localhost -p <span class="m">5432</span> --username<span class="o">=</span>postgres &lt; pg_dump.sql
</pre></div>
</div>
<p>If you would like to experiment with PostgreSQL programmatically, you can use
the following code snippet as a starting point:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thoth.storages</span> <span class="kn">import</span> <span class="n">GraphDatabase</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="c1"># To clear database:</span>
<span class="c1"># graph.drop_all()</span>
<span class="c1"># To initialize schema in the graph database:</span>
<span class="c1"># graph.initialize_schema()</span>
</pre></div>
</div>
</section>
<section id="generating-migrations-and-schema-adjustment-in-deployment">
<h2>Generating migrations and schema adjustment in deployment<a class="headerlink" href="#generating-migrations-and-schema-adjustment-in-deployment" title="Permalink to this headline">¶</a></h2>
<p>If you make any changes to data model of the main PostgreSQL database, you need
to generate migrations. These migrations state how to adjust already existing
database with data in deployments. For this purpose, <a class="reference external" href="https://alembic.sqlalchemy.org">Alembic migrations</a> are used. Alembic can (<a class="reference external" href="https://alembic.sqlalchemy.org/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect">partially</a>)
automatically detect what has changed and how to adjust already existing
database in a deployment.</p>
<p>Alembic uses incremental version control, where each migration is versioned and
states how to migrate from previous state of database to the desired next state
- these versions are present in <code class="docutils literal notranslate"><span class="pre">alembic/versions</span></code> directory and are
automatically generated with procedure described bellow.</p>
<p>If you make any changes, follow the following steps which will generate version
for you:</p>
<ul>
<li><p>Make sure your local PostgreSQL instance is running (follow <cite>Running
PostgreSQL locally</cite> instructions above):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>podman-compose up
</pre></div>
</div>
</li>
<li><p>Run Alembic CLI to generate versions for you:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Make sure you have your environment setup:
<span class="gp"># </span>pipenv install --dev
<span class="gp"># </span>Make sure you are running the most recent version of schema:
<span class="gp">$ </span><span class="nv">PYTHONPATH</span><span class="o">=</span>. pipenv run alembic upgrade head
<span class="gp"># </span>Actually generate a new version:
<span class="gp">$ </span><span class="nv">PYTHONPATH</span><span class="o">=</span>. pipenv run alembic revision --autogenerate -m <span class="s2">&quot;Added row to calculate sum of sums which will be divided by 42&quot;</span>
</pre></div>
</div>
</li>
<li><p>Review migrations generated by Alembic. Note <a class="reference external" href="https://alembic.sqlalchemy.org/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect">NOT all changes are
automatically detected by Alembic</a>.</p></li>
<li><p>Make sure generated migrations are part of your pull request so changes are
propagated to deployments:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git add thoth/storages/data/alembic/versions/
</pre></div>
</div>
</li>
<li><p>In a deployment, use Management API and its <code class="docutils literal notranslate"><span class="pre">/graph/initialize</span></code> endpoint to
propagate database schema changes in deployment (Management API has to have
recent schema changes present which are populated with new <code class="docutils literal notranslate"><span class="pre">thoth-storages</span></code>
releases).</p></li>
<li><p>If running locally and you would like to propagate changes, run the following
Alembic command to update migrations to the latest version:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">PYTHONPATH</span><span class="o">=</span>. pipenv run alembic upgrade head
</pre></div>
</div>
<p>If you would like to update schema programmatically run the following Python
code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thoth.storages</span> <span class="kn">import</span> <span class="n">GraphDatabase</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">initilize_schema</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
<p>When updating a deployment, make sure all the components use the same database
schema. Metrics exposed from a deployment should state schema version of all
the components in a deployment.</p>
</section>
<section id="generate-schema-images">
<h2>Generate schema images<a class="headerlink" href="#generate-schema-images" title="Permalink to this headline">¶</a></h2>
<p>You can use shipped CLI <code class="docutils literal notranslate"><span class="pre">thoth-storages</span></code> to automatically generate schema
images out of the current models:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>First, make sure you have dev packages installed:
<span class="gp">$ </span>pipenv install --dev
<span class="gp">$ </span><span class="nv">PYTHONPATH</span><span class="o">=</span>. pipenv run python3 ./thoth-storages generate-schema
</pre></div>
</div>
<p>The command above will produce an image named <code class="docutils literal notranslate"><span class="pre">schema.png</span></code>. Check <code class="docutils literal notranslate"><span class="pre">--help</span></code>
to get more info on available options.</p>
<p>If the command above fails with the following exception:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">FileNotFoundError: [Errno 2] &quot;dot&quot; not found in path.</span>
</pre></div>
</div>
<p>make sure you have <code class="docutils literal notranslate"><span class="pre">graphviz</span></code> package installed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dnf install -y graphviz</span>
</pre></div>
</div>
</section>
<section id="creating-own-performance-indicators">
<h2>Creating own performance indicators<a class="headerlink" href="#creating-own-performance-indicators" title="Permalink to this headline">¶</a></h2>
<p>Performance indicators report performance aspect of a library on <a class="reference external" href="https://github.com/thoth-station/amun-api">Amun</a> and results can be automatically
synced if the following procedure is respected.</p>
<p>To create own performance
indicator, create a script which tests desired functionality of a library. An
example can be matrix multiplication script present in <a class="reference external" href="https://github.com/thoth-station/performance/blob/master/tensorflow/matmul.py">thoth-station/performance</a>
repository. This script can be supplied to <a class="reference external" href="https://thoth-station.ninja/docs/developers/adviser/dependency_monkey.html">Dependency Monkey</a>
to validate certain combination of libraries in desired runtime and buildtime
environment. Please follow instructions on how to create a performance script
shown in the <a class="reference external" href="https://github.com/thoth-station/performance">README of performance repo</a>.</p>
<p>To create relevant models, adjust
<code class="docutils literal notranslate"><span class="pre">thoth/storages/graph/models_performance.py</span></code> file and add your model.
Describe parameters (reported in <code class="docutils literal notranslate"><span class="pre">&#64;parameters</span></code> section of performance
indicator result) and result (reported in <code class="docutils literal notranslate"><span class="pre">&#64;result</span></code>). The name of class
should match <code class="docutils literal notranslate"><span class="pre">name</span></code> which is reported by performance indicator run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PiMatmul</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">BaseExtension</span><span class="p">,</span> <span class="n">PerformanceIndicatorBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for representing a matrix multiplication micro-performance test.&quot;&quot;&quot;</span>

    <span class="c1"># Device used during performance indicator run - CPU/GPU/TPU/...</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">matrix_size</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">reps</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>All the models use <a class="reference external" href="https://www.sqlalchemy.org/">SQLAchemy</a>.  See <a class="reference external" href="https://docs.sqlalchemy.org/">docs</a> for more info.</p>
</section>
<section id="online-debugging-of-queries">
<h2>Online debugging of queries<a class="headerlink" href="#online-debugging-of-queries" title="Permalink to this headline">¶</a></h2>
<p>You can print to logger all the queries that are performed to a PostgreSQL
instance. To do so, set the following environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export THOTH_STORAGES_DEBUG_QUERIES=1</span>
</pre></div>
</div>
</section>
<section id="memory-usage-statisticts">
<h2>Memory usage statisticts<a class="headerlink" href="#memory-usage-statisticts" title="Permalink to this headline">¶</a></h2>
<p>You can print information about PostgreSQL adapter together with statistics on
the adapter in-memory cache usage to logger (it has to have at least level
<code class="docutils literal notranslate"><span class="pre">INFO</span></code> set). To do so, set the following environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export THOTH_STORAGES_LOG_STATS=1</span>
</pre></div>
</div>
<p>These statistics will be printed once the database adapter is destructed.</p>
</section>
<section id="automatic-backups-of-thoth-deployment">
<h2>Automatic backups of Thoth deployment<a class="headerlink" href="#automatic-backups-of-thoth-deployment" title="Permalink to this headline">¶</a></h2>
<p>In each deployment, an automatic knowledge <a class="reference external" href="https://github.com/thoth-station/graph-backup-job">graph backup cronjob</a> is run, usually once a
day. Results of automatic backups are stored on Ceph - you can find them in
<code class="docutils literal notranslate"><span class="pre">s3://&lt;bucket-name&gt;/&lt;prefix&gt;/&lt;deployment-name&gt;/graph-backup/pg_dump-&lt;timestamp&gt;.sql</span></code>.
Refer to deployment configuration for expansion of parameters in the path.</p>
<p>To create a database instance out of this backup file, run a fresh local
PostgreSQL instance and fill it from the backup file:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> thoth-station/storages
<span class="gp">$ </span>aws s3 --endpoint &lt;ceph-s3-endpoint&gt; cp s3://&lt;bucket-name&gt;/&lt;prefix&gt;/&lt;deployment-name&gt;/graph-backup/pg_dump-&lt;timestamp&gt; pg_dump-&lt;timestamp&gt;.sql
<span class="gp">$ </span>podman-compose up
<span class="gp">$ </span>psql -h localhost -p <span class="m">5432</span> --username<span class="o">=</span>postgres &lt; pg_dump-&lt;timestamp&gt;.sql
<span class="go">password: &lt;type password &quot;postgres&quot; here&gt;</span>
<span class="go">&lt;logs will show up&gt;</span>
</pre></div>
</div>
</section>
<section id="manual-backups-of-thoth-deployment">
<h2>Manual backups of Thoth deployment<a class="headerlink" href="#manual-backups-of-thoth-deployment" title="Permalink to this headline">¶</a></h2>
<p>You can use <code class="docutils literal notranslate"><span class="pre">pg_dump</span></code> and <code class="docutils literal notranslate"><span class="pre">psql</span></code> utilities to create dumps and restore the
database content from dumps. This tool is pre-installed in the container image
which is running PostgreSQL so the only thing you need to do is execute
<code class="docutils literal notranslate"><span class="pre">pg_dump</span></code> in Thoth’s deployment in a PostgreSQL container to create a dump,
use <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">cp</span></code> to retrieve dump (or directly use <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">exec</span></code> and create the dump
from the cluster) and subsequently <code class="docutils literal notranslate"><span class="pre">psql</span></code> to restore the database content.
The prerequisite for this is to have access to the running container (edit
rights).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Execute the following commands from the root of this Git repo:
<span class="gp"># </span>List PostgreSQL pods running:
<span class="gp">$ </span>oc get pod -l <span class="nv">name</span><span class="o">=</span>postgresql
<span class="go">NAME                 READY     STATUS    RESTARTS   AGE</span>
<span class="go">postgresql-1-glwnr   1/1       Running   0          3d</span>
<span class="gp"># </span>Open remote shell to the running container <span class="k">in</span> the PostgreSQL pod:
<span class="gp">$ </span>oc rsh -t postgresql-1-glwnr bash
<span class="gp"># </span>Perform dump of the database:
<span class="gp gp-VirtualEnv">(cluster-postgres)</span> <span class="gp">$ </span>pg_dump &gt; pg_dump-<span class="k">$(</span>date +<span class="s2">&quot;%s&quot;</span><span class="k">)</span>.sql
<span class="gp gp-VirtualEnv">(cluster-postgres)</span> <span class="gp">$ </span>ls pg_dump-*.sql   <span class="c1"># Remember the current dump name</span>
<span class="gp gp-VirtualEnv">(cluster-postgres)</span> <span class="go">pg_dump-1569491024.sql</span>
<span class="gp gp-VirtualEnv">(cluster-postgres)</span> <span class="gp">$ </span><span class="nb">exit</span>
<span class="gp"># </span>Copy the dump to the current dir:
<span class="gp">$ </span>oc cp thoth-test-core/postgresql-1-glwnr:/opt/app-root/src/pg_dump-1569491024.sql  .
<span class="gp"># </span>Start <span class="nb">local</span> PostgreSQL instance:
<span class="gp">$ </span>podman-compose up --detach
<span class="go">&lt;logs will show up&gt;</span>
<span class="gp">$ </span>psql -h localhost -p <span class="m">5432</span> --username<span class="o">=</span>postgres &lt; pg_dump-1569491024.sql
<span class="go">password: &lt;type password &quot;postgres&quot; here&gt;</span>
<span class="go">&lt;logs will show up&gt;</span>
</pre></div>
</div>
<p>You can ignore error messages related to an owner error like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">STATEMENT:  ALTER TABLE public.python_software_stack OWNER TO thoth;</span>
<span class="go">ERROR:  role &quot;thoth&quot; does not exist</span>
</pre></div>
</div>
<p>The PostgreSQL container uses user “postgres” by default which is different
from the one run in the cluster (“thoth”). The role assignment will simply not
be created but data will be available.</p>
</section>
<section id="syncing-results-of-a-workflow-run-in-the-cluster">
<h2>Syncing results of a workflow run in the cluster<a class="headerlink" href="#syncing-results-of-a-workflow-run-in-the-cluster" title="Permalink to this headline">¶</a></h2>
<p>Each workflow task in the cluster reports a JSON which states necessary
information about the task run (metadata) and actual results. These results of
workflow tasks are stored on object storage <a class="reference external" href="https://ceph.io/">Ceph</a> via S3
compatible API and later on synced via graph syncs to the knowledge graph. The
component responsible for graph syncs is <a class="reference external" href="https://github.com/thoth-station/graph-sync-job">graph-sync-job</a> which is written generic
enough to sync any data and report metrics about synced data so you don’t need
to provide such logic on each new workload registered in the system. To sync
your own results of job results (workload) done in the cluster, implement
related syncing logic in the <a class="reference external" href="https://github.com/thoth-station/storages/blob/master/thoth/storages/sync.py">sync.py</a>
and register handler in the <code class="docutils literal notranslate"><span class="pre">HANDLERS_MAPPING</span></code> in the same file. The mapping
maps prefix of the document id to the handler (function) which is responsible
for syncing data into the knowledge base (please mind signatures of existing
syncing functions to automatically integrate with <code class="docutils literal notranslate"><span class="pre">sync_documents</span></code> function
which is called from <code class="docutils literal notranslate"><span class="pre">graph-sync-job</span></code>).</p>
</section>
<section id="query-naming-conventions-in-thoth">
<h2>Query Naming conventions in Thoth<a class="headerlink" href="#query-naming-conventions-in-thoth" title="Permalink to this headline">¶</a></h2>
<p>For query naming conventions, please read all the docs in <a class="reference external" href="https://github.com/thoth-station/storages/blob/master/docs/conventions/README.md">conventions for
query name</a>.</p>
</section>
<section id="accessing-data-on-ceph">
<h2>Accessing data on Ceph<a class="headerlink" href="#accessing-data-on-ceph" title="Permalink to this headline">¶</a></h2>
<p>To access data on Ceph, you need to know <code class="docutils literal notranslate"><span class="pre">aws_access_key_id</span></code> and <code class="docutils literal notranslate"><span class="pre">aws_secret_access_key</span></code> credentials
of endpoint you are connecting to.</p>
<p>Absolute file path of data you are accessing is constructed as: <code class="docutils literal notranslate"><span class="pre">s3://&lt;bucket_name&gt;/&lt;prefix_name&gt;/&lt;file_path&gt;</span></code></p>
<p>There are two ways to initialize the data handler:</p>
<ol class="arabic">
<li><p>Configure environment variables</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable name</p></th>
<th class="head"><p>Content</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">S3_ENDPOINT_URL</span></code></p></td>
<td><p>Ceph Host name</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CEPH_BUCKET</span></code></p></td>
<td><p>Ceph Bucket name</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CEPH_BUCKET_PREFIX</span></code></p></td>
<td><p>Ceph Prefix</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CEPH_KEY_ID</span></code></p></td>
<td><p>Ceph Key ID</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CEPH_SECRET_KEY</span></code></p></td>
<td><p>Ceph Secret Key</p></td>
</tr>
</tbody>
</table>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thoth.storages.ceph</span> <span class="kn">import</span> <span class="n">CephStore</span>
<span class="n">ceph</span> <span class="o">=</span> <span class="n">CephStore</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Initialize the object directly with parameters</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thoth.storages.ceph</span> <span class="kn">import</span> <span class="n">CephStore</span>
<span class="n">ceph</span> <span class="o">=</span> <span class="n">CephStore</span><span class="p">(</span>
    <span class="n">key_id</span><span class="o">=&lt;</span><span class="n">aws_access_key_id</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">secret_key</span><span class="o">=&lt;</span><span class="n">aws_secret_access_key</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">prefix</span><span class="o">=&lt;</span><span class="n">prefix_name</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">host</span><span class="o">=&lt;</span><span class="n">endpoint_url</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">bucket</span><span class="o">=&lt;</span><span class="n">bucket_name</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<p>After initialization, you are ready to retrieve data</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># For dictionary stored as json</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">ceph</span><span class="o">.</span><span class="n">retrieve_document</span><span class="p">(</span><span class="o">&lt;</span><span class="n">file_path</span><span class="o">&gt;</span><span class="p">)</span>

    <span class="c1"># For general blob</span>
    <span class="n">blob</span> <span class="o">=</span> <span class="n">ceph</span><span class="o">.</span><span class="n">retrieve_blob</span><span class="p">(</span><span class="o">&lt;</span><span class="n">file_path</span><span class="o">&gt;</span><span class="p">)</span>

<span class="k">except</span> <span class="n">NotFoundError</span><span class="p">:</span>
    <span class="c1"># File does not exist</span>
</pre></div>
</div>
</section>
<section id="accessing-thoth-data-on-the-operate-first-public-bucket">
<h2>Accessing Thoth Data on the Operate-First Public Bucket<a class="headerlink" href="#accessing-thoth-data-on-the-operate-first-public-bucket" title="Permalink to this headline">¶</a></h2>
<p>A public instance of Thoth’s database is available on the <a class="reference external" href="https://github.com/operate-first/apps/blob/master/docs/content/odh/trino/access_public_bucket.md">Operate-First Public Bucket</a> for external contributors to start developing components of Thoth.</p>
<p>Instructions for accessing the bucket are available in the <a class="reference external" href="https://github.com/thoth-station/datasets#accessing-thoth-data-on-the-operate-first-public-bucket">documentation</a> of the <a class="reference external" href="https://github.com/thoth-station/datasets">thoth/datasets</a> repository.</p>
<p>Be careful not to store any confidential or valuable information in this bucket as its content can be wiped out at any time.</p>
</section>
<section id="knowledge-graph-schema">
<h2>Knowledge graph schema<a class="headerlink" href="#knowledge-graph-schema" title="Permalink to this headline">¶</a></h2>
<a class="reference external image-reference" href="/assets/storages/schema.png"><img alt="Knowledge graph schema." src="/assets/schema.png" /></a>
</section>
<section id="crossroad">
<h2>Crossroad<a class="headerlink" href="#crossroad" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="../thamos">Documentation for thamos</a></p></li>
<li><p><a class="reference external" href="../adviser">Documentation for thoth-adviser</a></p></li>
<li><p><a class="reference external" href="../analyzer">Documentation for thoth-analyzer</a></p></li>
<li><p><a class="reference external" href="../common">Documentation for thoth-common</a></p></li>
<li><p><a class="reference external" href="../lab">Documentation for thoth-lab</a></p></li>
<li><p><a class="reference external" href="../package-analyzer">Documentation for thoth-package-analyzer</a></p></li>
<li><p><a class="reference external" href="../package-extract">Documentation for thoth-package-extract</a></p></li>
<li><p><a class="reference external" href="../python">Documentation for thoth-python</a></p></li>
<li><p><a class="reference external" href="../solver">Documentation for thoth-solver</a></p></li>
<li><p><a class="reference external" href="../kebechet">Documentation for kebechet</a></p></li>
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="thoth.storages.html">thoth.storages package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#subpackages">Subpackages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="thoth.storages.graph.html">thoth.storages.graph package</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.advisers">thoth.storages.advisers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.advisers_cache">thoth.storages.advisers_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.analyses">thoth.storages.analyses module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.analyses_by_digest">thoth.storages.analyses_by_digest module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.analyses_cache">thoth.storages.analyses_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.base">thoth.storages.base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.buildlogs">thoth.storages.buildlogs module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.buildlogs_analyses_cache">thoth.storages.buildlogs_analyses_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.buildlogs_parsed">thoth.storages.buildlogs_parsed module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.ceph">thoth.storages.ceph module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.ceph_cache">thoth.storages.ceph_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.cli">thoth.storages.cli module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.dependency_monkey_reports">thoth.storages.dependency_monkey_reports module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.dependency_monkey_requests">thoth.storages.dependency_monkey_requests module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.exceptions">thoth.storages.exceptions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.graph_backup">thoth.storages.graph_backup module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.inspection_schema">thoth.storages.inspection_schema module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.inspections">thoth.storages.inspections module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.logs">thoth.storages.logs module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.observations">thoth.storages.observations module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.provenance">thoth.storages.provenance module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.provenance_cache">thoth.storages.provenance_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.result_base">thoth.storages.result_base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.result_schema">thoth.storages.result_schema module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.revsolvers">thoth.storages.revsolvers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.security_indicators">thoth.storages.security_indicators module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.solvers">thoth.storages.solvers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.sync">thoth.storages.sync module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages">Module contents</a></li>
</ul>
</li>
</ul>
</div>
<p>This documentation corresponds to implementation in version 0.73.2,
documentation was generated on Sep 19, 2022.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Thoth Storages</a><ul>
<li><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li><a class="reference internal" href="#installation-and-usage">Installation and Usage</a></li>
<li><a class="reference internal" href="#running-postgresql-locally">Running PostgreSQL locally</a></li>
<li><a class="reference internal" href="#generating-migrations-and-schema-adjustment-in-deployment">Generating migrations and schema adjustment in deployment</a></li>
<li><a class="reference internal" href="#generate-schema-images">Generate schema images</a></li>
<li><a class="reference internal" href="#creating-own-performance-indicators">Creating own performance indicators</a></li>
<li><a class="reference internal" href="#online-debugging-of-queries">Online debugging of queries</a></li>
<li><a class="reference internal" href="#memory-usage-statisticts">Memory usage statisticts</a></li>
<li><a class="reference internal" href="#automatic-backups-of-thoth-deployment">Automatic backups of Thoth deployment</a></li>
<li><a class="reference internal" href="#manual-backups-of-thoth-deployment">Manual backups of Thoth deployment</a></li>
<li><a class="reference internal" href="#syncing-results-of-a-workflow-run-in-the-cluster">Syncing results of a workflow run in the cluster</a></li>
<li><a class="reference internal" href="#query-naming-conventions-in-thoth">Query Naming conventions in Thoth</a></li>
<li><a class="reference internal" href="#accessing-data-on-ceph">Accessing data on Ceph</a></li>
<li><a class="reference internal" href="#accessing-thoth-data-on-the-operate-first-public-bucket">Accessing Thoth Data on the Operate-First Public Bucket</a></li>
<li><a class="reference internal" href="#knowledge-graph-schema">Knowledge graph schema</a></li>
<li><a class="reference internal" href="#crossroad">Crossroad</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation index</a><ul>
      <li>Next: <a href="thoth.storages.html" title="next chapter">thoth.storages package</a></li>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="sources/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

  
  </div>
  
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>