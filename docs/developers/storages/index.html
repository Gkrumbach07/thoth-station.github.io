<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Thoth Storages &#8212; Thoth Storages 0.19.3 documentation</title>
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="thoth.storages package" href="thoth.storages.html" />

    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123174547-2']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="#">Thoth Storages 0.19.3 documentation</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="thoth-storages">
<h1>Thoth Storages<a class="headerlink" href="#thoth-storages" title="Permalink to this headline">¶</a></h1>
<p>This library provides a library called <a class="reference external" href="https://pypi.org/project/thoth-storages">thoth-storages</a> used in project <a class="reference external" href="https://thoth-station.ninja">Thoth</a>.  The library exposes core queries and methods
for PostgreSQL database as well as adapters for manipulating with Ceph via its
S3 compatible API.</p>
<div class="section" id="installation-and-usage">
<h2>Installation and Usage<a class="headerlink" href="#installation-and-usage" title="Permalink to this headline">¶</a></h2>
<p>The library can be installed via pip or Pipenv from
<a class="reference external" href="https://pypi.org/project/thoth-storages">PyPI</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pipenv install thoth-storages</span>
</pre></div>
</div>
<p>The library does not provide any CLI, it is rather a low level library
supporting other parts of Thoth.</p>
<p>You can run prepared testsuite via the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pipenv install --dev</span>
<span class="go">pipenv run python3 setup.py test</span>

<span class="gp">#</span> To generate docs:
<span class="go">pipenv run python3 setup.py build_sphinx</span>
</pre></div>
</div>
</div>
<div class="section" id="running-postgresql-locally">
<h2>Running PostgreSQL locally<a class="headerlink" href="#running-postgresql-locally" title="Permalink to this headline">¶</a></h2>
<p>You can use <cite>docker-compose</cite> present in this repository to run a local PostgreSQL instance:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> docker-compose up
</pre></div>
</div>
<p>After running the command above (make sure your big fat daemon is up using <cite>systemctl start docker</cite>), you should be able to access a local PostgreSQL instance at <cite>localhost:5432</cite>. This is also the default configuration for PostgreSQL’s adapter - you don’t need to provide <cite>GRAPH_SERVICE_HOST</cite> explicitly. The default configuration uses database named <cite>thoth</cite> which can be accessed using <cite>postgres</cite> user and <cite>postgres</cite> password (SSL is disabled).</p>
<p>The provided <cite>docker-compose</cite> has also PGweb enabled for to have an UI for the database content. To access it visit <a class="reference external" href="http://localhost:8081">http://localhost:8081/</a>.</p>
<p>The provided <cite>docker-compose</cite> does not use any volume. After you containers restart, the content will not be available anymore.</p>
<p>If you would like to experiment with PostgreSQL programatically, you can use the following code snippet as a starting point:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thoth.storages</span> <span class="kn">import</span> <span class="n">GraphDatabase</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="c1"># To clear database:</span>
<span class="c1"># graph.drop_all()</span>
<span class="c1"># To initialize schema in the graph database:</span>
<span class="c1"># graph.initialize_schema()</span>
</pre></div>
</div>
</div>
<div class="section" id="schema-adjustment-in-deployment">
<h2>Schema adjustment in deployment<a class="headerlink" href="#schema-adjustment-in-deployment" title="Permalink to this headline">¶</a></h2>
<p>TBD.</p>
</div>
<div class="section" id="generate-schema-images">
<h2>Generate schema images<a class="headerlink" href="#generate-schema-images" title="Permalink to this headline">¶</a></h2>
<p>You can use shipped CLI <code class="docutils literal notranslate"><span class="pre">thoth-storages</span></code> to automatically generate schema images out of the current models:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> First, make sure you have dev packages installed:
<span class="go">pipenv install --dev</span>
<span class="go">PYTHONPATH=. pipenv run python3 ./thoth-storages generate-schema</span>
</pre></div>
</div>
<p>The command above will produce 2 images named <code class="docutils literal notranslate"><span class="pre">schema.png</span></code> and
<code class="docutils literal notranslate"><span class="pre">schema_cache.png</span></code>. The first PNG file shows schema for the main PostgreSQL
instance and the latter one, as the name suggests, shows how cache schema looks
like.</p>
</div>
<div class="section" id="creating-own-performance-indicators">
<h2>Creating own performance indicators<a class="headerlink" href="#creating-own-performance-indicators" title="Permalink to this headline">¶</a></h2>
<p>You can create your own performance indicators. To create own performance
indicator, create a script which tests desired functionality of a library. An
example can be matrix multiplication script present in <a class="reference external" href="https://github.com/thoth-station/performance/blob/master/tensorflow/matmul.py">performance</a>
repository. This script can be supplied to Dependency Monkey to validate
certain combination of libraries in desired runtime and buildtime environment
or directly on Amun API which will run the given script using desired software
and hardware configuration. Please follow instructions on how to create a
performance script shown in the <a class="reference external" href="https://github.com/thoth-station/performance">README of performance repo</a>.</p>
<p>To create relevant models, adjust <cite>thoth/storages/graph/models_performance.py</cite> file
and add your model. Describe parameters (reported in <cite>&#64;parameters</cite> section of
performance indicator result) and result (reported in <cite>&#64;result</cite>). The name of
class should match <cite>name</cite> which is reported by performance indicator run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PiMatmul</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">BaseExtension</span><span class="p">,</span> <span class="n">PerformanceIndicatorBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for representing a matrix multiplication micro-performance test.&quot;&quot;&quot;</span>

    <span class="c1"># Device used during performance indicator run - CPU/GPU/TPU/...</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">matrix_size</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">reps</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>All the models use <a class="reference external" href="https://www.sqlalchemy.org/">SQLAchemy</a>.
See <a class="reference external" href="https://docs.sqlalchemy.org/">docs</a> for more info.</p>
</div>
<div class="section" id="online-debugging-of-queries">
<h2>Online debugging of queries<a class="headerlink" href="#online-debugging-of-queries" title="Permalink to this headline">¶</a></h2>
<p>You can print to logger all the queries that are performed to a PostgreSQL instance. To do so, set the following environment variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">THOTH_STORAGES_DEBUG_QUERIES</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>Online debugging of queries<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>You can print information about PostgreSQL adapter together with statisics on
the graph cache and memory cache usage to logger (it has to have at least level
<cite>INFO</cite> set). To do so, set the following environment variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">THOTH_STORAGES_LOG_STATS</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>These statistics will be printed once the database adapter is destructed.</p>
</div>
<div class="section" id="graph-database-cache">
<h2>Graph database cache<a class="headerlink" href="#graph-database-cache" title="Permalink to this headline">¶</a></h2>
<p>The implementation of this library also provides a cache to speed up queries to
graph database. This cache is especially suitable for prod systems not to query
for popular packages multiple times.</p>
<p>The cache can be created with shipped CLI tool:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> When using version from this Git repository:
<span class="go">PYTHONPATH=. THOTH_STORAGES_GRAPH_CACHE=&quot;cache.sqlite3&quot; pipenv run ./thoth-storages graph-cache -c ../adviser/cache_conf.yaml</span>

<span class="gp">#</span> When using a version installed from PyPI:
<span class="go">THOTH_STORAGES_GRAPH_CACHE=&quot;cache.sqlite3&quot; thoth-storages graph-cache -c ../adviser/cache_conf.yaml</span>
</pre></div>
</div>
<p>The command above creates a SQLite3 database which carries some of the data
loaded from the PostgreSQL database which help resolver resolve software stacks
faster.  The path to cache can be supplied using environment variable
<code class="docutils literal notranslate"><span class="pre">THOTH_STORAGES_GRAPH_CACHE</span></code>. By default, the module will create an in-memory
SQLite3 database and will not persist it onto disk. If the configuration points
to non-existing file, an SQLite3 database will be created and persisted onto
disk with data which were added into it based on runtime usage. This naturally
re-uses graph cache multiple times across runs (filled with the data needed) as
expected.</p>
<p>Take a look at adviser repo, at <code class="docutils literal notranslate"><span class="pre">cache_conf.yaml</span></code> file specifically, to
see how <code class="docutils literal notranslate"><span class="pre">cache_conf.yaml</span></code> file should be structured. An example could be:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">python-packages</span><span class="p">:</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">thoth-storages</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tensorflow</span>
</pre></div>
</div>
<p>With the configuration above, the cache will be created. This cache will hold a
serialized dependency graph of TensorFlow and thoth-storages packages, together
with node information to effectively construct TensorFlow’s dependency graph
for transitive queries.</p>
<p>Note only information which should not change over time are captured in the
cache; for example, packages which were not yet resolved during cache creation
are not added to cache so system explicitly asks for resolution results next
time (they might be resolved meanwhile).</p>
<p>To enable inserts into graph cache, set
<code class="docutils literal notranslate"><span class="pre">THOTH_STORAGES_GRAPH_CACHE_INSERTS_DISABLED</span></code> to <code class="docutils literal notranslate"><span class="pre">0</span></code> (the default value of
<code class="docutils literal notranslate"><span class="pre">1</span></code> disables it). Disabling inserts might be benefitial in deployments where
you want to avoid building cache (overhead needed to insert data into graph
cache, checks of uniqueness of entries and cache index creation which in sum
are expensive operations).</p>
<p>To disable graph cache completely, set <code class="docutils literal notranslate"><span class="pre">THOTH_STORAGES_GRAPH_CACHE_DISABLED</span></code>
environment variable to <code class="docutils literal notranslate"><span class="pre">1</span></code> (the default value of <code class="docutils literal notranslate"><span class="pre">0</span></code> enables it).</p>
</div>
<div class="section" id="graph-database-schema">
<h2>Graph Database Schema<a class="headerlink" href="#graph-database-schema" title="Permalink to this headline">¶</a></h2>
<img alt="Graph database schema" src="https://raw.githubusercontent.com/thoth-station/storages/master/docs/schema.png" />
<p>Graph database schema is automatically generated by <a class="reference external" href="https://raw.githubusercontent.com/thoth-station/storages/master/docs/schema.png">Dia</a>. You can install it from repositories. Issue the following command in Fedora:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dnf install dia</span>
</pre></div>
</div>
<p>You can find <code class="docutils literal notranslate"><span class="pre">schema.dia</span></code> in <a class="reference external" href="https://github.com/thoth-station/storages/tree/master/docs">Git repository of thoth-storages repository</a>. Do not forget
to export changes made to schema diagram to the PNG file in the same directory.</p>
</div>
<div class="section" id="crossroad">
<h2>Crossroad<a class="headerlink" href="#crossroad" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="thoth.storages.html">thoth.storages package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#subpackages">Subpackages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="thoth.storages.graph.html">thoth.storages.graph package</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.advisers">thoth.storages.advisers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.advisers_cache">thoth.storages.advisers_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.analyses">thoth.storages.analyses module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.analyses_by_digest">thoth.storages.analyses_by_digest module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.analyses_cache">thoth.storages.analyses_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.base">thoth.storages.base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.buildlogs">thoth.storages.buildlogs module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.buildlogs_analyses">thoth.storages.buildlogs_analyses module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.buildlogs_analyses_cache">thoth.storages.buildlogs_analyses_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.ceph">thoth.storages.ceph module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.ceph_cache">thoth.storages.ceph_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.cli">thoth.storages.cli module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.dependency_monkey_reports">thoth.storages.dependency_monkey_reports module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.exceptions">thoth.storages.exceptions module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.graph_cache">thoth.storages.graph_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.inspection_schema">thoth.storages.inspection_schema module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.inspections">thoth.storages.inspections module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.observations">thoth.storages.observations module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.package_analyses">thoth.storages.package_analyses module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.provenance">thoth.storages.provenance module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.provenance_cache">thoth.storages.provenance_cache module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.result_base">thoth.storages.result_base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.result_schema">thoth.storages.result_schema module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.solvers">thoth.storages.solvers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages.sync">thoth.storages.sync module</a></li>
<li class="toctree-l2"><a class="reference internal" href="thoth.storages.html#module-thoth.storages">Module contents</a></li>
</ul>
</li>
</ul>
</div>
<p>This documentation corresponds to implementation in version 0.19.3,
documentation was generated on Sep 18, 2019.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

  <h3><a href="#">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Thoth Storages</a><ul>
<li><a class="reference internal" href="#installation-and-usage">Installation and Usage</a></li>
<li><a class="reference internal" href="#running-postgresql-locally">Running PostgreSQL locally</a></li>
<li><a class="reference internal" href="#schema-adjustment-in-deployment">Schema adjustment in deployment</a></li>
<li><a class="reference internal" href="#generate-schema-images">Generate schema images</a></li>
<li><a class="reference internal" href="#creating-own-performance-indicators">Creating own performance indicators</a></li>
<li><a class="reference internal" href="#online-debugging-of-queries">Online debugging of queries</a></li>
<li><a class="reference internal" href="#id2">Online debugging of queries</a></li>
<li><a class="reference internal" href="#graph-database-cache">Graph database cache</a></li>
<li><a class="reference internal" href="#graph-database-schema">Graph Database Schema</a></li>
<li><a class="reference internal" href="#crossroad">Crossroad</a></li>
</ul>
</li>
</ul>

  <h4>Next topic</h4>
  <p class="topless"><a href="thoth.storages.html"
                        title="next chapter">thoth.storages package</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="thoth.storages.html" title="thoth.storages package"
             accesskey="N">next</a> |</li>
      </ul>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Thoth team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
    </div>
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>