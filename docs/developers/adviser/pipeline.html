<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>State expansion pipeline &#8212; Thoth Adviser 0.6.1 documentation</title>
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Provenance Checks" href="provenance_checks.html" />
    <link rel="prev" title="Performance indicators" href="performance.html" />

    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123174547-2']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="index.html">Thoth Adviser 0.6.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="state-expansion-pipeline">
<span id="pipeline"></span><h1>State expansion pipeline<a class="headerlink" href="#state-expansion-pipeline" title="Permalink to this headline">¶</a></h1>
<p>In this section, one can find the developer’s introduction to state expansion
pipeline used in Thoth’s adviser that expands states to produce pipeline products.</p>
<p>The pipeline is used to prepare, generate, filter and score partially or fully
resolved software stacks, abstracted into a <a class="reference internal" href="thoth.adviser.html#thoth.adviser.state.State" title="thoth.adviser.state.State"><code class="xref py py-class docutils literal notranslate"><span class="pre">State</span></code></a>.  The pipeline is run within <a class="reference internal" href="anneal.html#anneal"><span class="std std-ref">adaptive
simulated annealing</span></a> which encapsulates results (final states) of the
pipeline runs into a higher abstraction called <a class="reference internal" href="thoth.adviser.html#thoth.adviser.product.Product" title="thoth.adviser.product.Product"><code class="xref py py-class docutils literal notranslate"><span class="pre">Product</span></code></a> which can subsequently become part of a
<a class="reference internal" href="thoth.adviser.html#thoth.adviser.report.Report" title="thoth.adviser.report.Report"><code class="xref py py-class docutils literal notranslate"><span class="pre">Report</span></code></a> (see methods
<a class="reference internal" href="thoth.adviser.html#thoth.adviser.anneal.AdaptiveSimulatedAnnealing.anneal" title="thoth.adviser.anneal.AdaptiveSimulatedAnnealing.anneal"><code class="xref py py-func docutils literal notranslate"><span class="pre">AdaptiveSimulatedAnnealing.anneal</span></code></a> and
<a class="reference internal" href="thoth.adviser.html#thoth.adviser.anneal.AdaptiveSimulatedAnnealing.anneal_products" title="thoth.adviser.anneal.AdaptiveSimulatedAnnealing.anneal_products"><code class="xref py py-func docutils literal notranslate"><span class="pre">AdaptiveSimulatedAnnealing.anneal_products</span></code></a> for more
info).</p>
<p>The input to the pipeline is Thoth’s <cite>Project</cite> abstraction carrying information
about direct dependencies of an application together with optional additional
vector stating software environment, hardware available and also an optional
result of a static source code analysis on user’s application for targeting
application specific recommendations (API used from libraries).</p>
<p>The pipeline is dynamically created based on the incoming vector to the state
generation pipeline, which makes Thoth’s adviser a reconfigurable resolver
suitable to resolve optimized software stacks for a specific use.</p>
<p>The pipeline consists of the following types of units:</p>
<ul class="simple">
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.boot.Boot" title="thoth.adviser.boot.Boot"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boot</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.sieve.Sieve" title="thoth.adviser.sieve.Sieve"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sieve</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.step.Step" title="thoth.adviser.step.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">Step</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.stride.Stride" title="thoth.adviser.stride.Stride"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stride</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.wrap.Wrap" title="thoth.adviser.wrap.Wrap"><code class="xref py py-class docutils literal notranslate"><span class="pre">Wrap</span></code></a></p></li>
</ul>
<div class="section" id="a-foreword-for-units">
<h2>A foreword for units<a class="headerlink" href="#a-foreword-for-units" title="Permalink to this headline">¶</a></h2>
<p>All units are derived from <a class="reference internal" href="thoth.adviser.html#thoth.adviser.unit.Unit" title="thoth.adviser.unit.Unit"><code class="xref py py-class docutils literal notranslate"><span class="pre">Unit</span></code></a> that
provides a common base for implemented units of any type. This way, each and
every unit can benefit from the shared functionality. The base class also
provides access to the input pipeline vectors and other properties:</p>
<ul class="simple">
<li><p><cite>project</cite> property can be used to access project information for which the
pipeline is producing software stacks, information about <strong>direct
dependencies</strong>, configured <strong>Python package indexes</strong> (see <cite>Pipfile</cite>
abstraction)</p></li>
<li><p>the <cite>Project</cite> abstraction (as can be found in Thoth’s <cite>thoth-python</cite> library)
also provides information about <strong>software environment</strong> (operating system
name and version, Python interpreter version used and additional information
such as IPython information when resolving software stacks for Jupyter
Notebooks)</p></li>
<li><p><strong>hardware information</strong> is also part of the <cite>Project</cite> abstraction and lets
users of Thoth provide information about hardware used (e.g. GPU card type)
eigher manually or by using automatic hardware discovery in the Thamos client
tool when submitting requests to Thoth’s backend</p></li>
<li><p><cite>library_usage</cite> property carries information about <strong>API calls to libraries</strong>,
that maps names of libraries to symbols used from user’s application (this
is in fact output of Thoth’s static analysis done on the source code - see
<a class="reference external" href="https://github.com/thoth-station/invectio/">Invectio</a>) - this way Thoth
can build adviser’s pipeline configuration that is optimized for example for
a convolutional neural network if there are detect calls to CNN API calls of
used libraries</p></li>
<li><p>an instantiated adapter to Thoth’s knowledge graph that aggregates
information about software packages, software run and build environments as
well as information about hardware that can be used during pipeline units run</p></li>
</ul>
</div>
<div class="section" id="pipeline-configuration-creation">
<h2>Pipeline configuration creation<a class="headerlink" href="#pipeline-configuration-creation" title="Permalink to this headline">¶</a></h2>
<p>Each pipeline unit provides a class method called <cite>should_include</cite> which is executed
on the <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_config.PipelineConfig" title="thoth.adviser.pipeline_config.PipelineConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">pipeline</span> <span class="pre">configuration</span> <span class="pre">creation</span></code></a> (that states a list of sieves,
steps and strides to be included in the pipeline). The class method returns a
dictionary stating unit configuration if the given unit should be used (an
empty dictionary if no configuration changes to unit parameters are done), a
special value of <cite>None</cite> indicates the given pipeline unit should not be added
to the pipeline configuration.</p>
<p>The <cite>should_include</cite> unit class method is in fact called multiple times during
pipeline configuration construction. The pipeline builder iterates over all
pipeline units and asks if they should be included in the pipeline
configuration until no change to the pipeline configuration is made. This way
pipeline can be constructed autonomously where a developer of a pipeline unit
just programatically states when the given pipeline unit should be included in
the pipeline configuration (stating dependencies on other pipeline units or
conditionally add pipeline unit under specific circumferences). An example can
be a pipeline unit which includes scoring based on performance indicators done
on <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/nn/conv2d">conv2d</a> used in a
TensorFlow application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># snip ...</span>

<span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">should_include</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">PipelineBuilderContext</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Include this pipeline unit if user uses TensorFlow and there are done calls to conv2d.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">is_included</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
       <span class="c1"># This pipeline unit is already included in the pipeline configuration, we don&#39;t</span>
       <span class="c1"># need to include this pipeline unit multiple times.</span>
       <span class="c1">#</span>
       <span class="c1"># The same method `is_included&#39; can be used to inspect if pre-requisite pipeline</span>
       <span class="c1"># units are present in the pipeline configuration.</span>
       <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">library_usage</span> <span class="ow">and</span> <span class="s2">&quot;tf.nn.conv2d&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">library_usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">,</span> <span class="p">{}):</span>
       <span class="c1"># As an example - adjust parameter `score_factor&#39; of this pipeline</span>
       <span class="c1"># unit to 2.0, which will override the default one.</span>
       <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;score_factor&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

<span class="c1"># ... snip</span>
</pre></div>
</div>
<p>On a pipeline run, there are first executed all sieves on all the resolved
packages which are considered to become a part of states, then all steps to
produce a final state and lastly all strides on a final state. Each unit type
respects relative ordering - the very first sieve added is run first, then a
second one and so on respecting the relative order of sieves in the pipeline
configuration (the order in which they were registered). The same logic applies
to steps and strides.</p>
<p>See implementation of <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_builder.PipelineBuilderContext" title="thoth.adviser.pipeline_builder.PipelineBuilderContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineBuilderContext</span></code></a> for more info on
provided methods that can be used during pipeline configuration creation.</p>
<p>Note the annealing algorithm with pipeline steps is shared for computing
advises and for Dependency Monkey to test and evaluate characteristics of
software stacks. You can use methods provided by <a class="reference internal" href="thoth.adviser.html#thoth.adviser.pipeline_builder.PipelineBuilderContext" title="thoth.adviser.pipeline_builder.PipelineBuilderContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">PipelineBuilderContext</span></code></a> to check if the
pipeline configuration is created for computing advises or whether the created
pipeline configuration is used in Dependency Monkey runs.</p>
</div>
<div class="section" id="boot">
<h2>Boot<a class="headerlink" href="#boot" title="Permalink to this headline">¶</a></h2>
<p>A very first pipeline unit is called “boot” as it boots up the whole pipeline.
It’s run prior to any resolution right after the simulated annealing is started.
A boot unit can be used to check parameters to the pipeline from semantics point
of view.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When to use a boot unit?</p>
<p>If you want to inspect supplied project to the pipeline or used runtime
environment. The boot part can for example block runtime environments which are
too old or are known to have serious issues (e.g. blocking OpenShift s2i
builds cluster wide by Thoth administrator).</p>
</div>
<p>Note any exception raised in a boot unit is causing a stop in the whole
stack recommendation request.</p>
</div>
<div class="section" id="sieve">
<h2>Sieve<a class="headerlink" href="#sieve" title="Permalink to this headline">¶</a></h2>
<p>The second pipeline unit called “<a class="reference external" href="https://en.wikipedia.org/wiki/Sieve">sieve</a>” is used to filter out packages which
should not occur in a software stack at all. An example use case can be
filtering packages which have installation issues in the given software
environment so there is no reason to produce software stacks with these
packages in recommendations.</p>
<p>An example implementation of a sieve implementation can be to use Thoth’s
knowledge graph to filter out packages which are not installable into the
software environment (e.g. installation of legacy Python2 packages when
Python3+ is used as described above):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;A sieve for filtering out build time/installation errors of Python packages.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">from</span> <span class="nn">thoth.python</span> <span class="kn">import</span> <span class="n">PackageVersion</span>
<span class="kn">from</span> <span class="nn">thoth.storages.exceptions</span> <span class="kn">import</span> <span class="n">NotFoundError</span>

<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">NotAcceptable</span>
<span class="kn">from</span> <span class="nn">..sieve</span> <span class="kn">import</span> <span class="n">Sieve</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..pipeline_builder</span> <span class="kn">import</span> <span class="n">PipelineBuilderContext</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@attr.s</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SolvedSieve</span><span class="p">(</span><span class="n">Sieve</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filter out build time/installation errors of Python packages.&quot;&quot;&quot;</span>

    <span class="n">PARAMETERS_DEFAULT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;without_error&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">should_include</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s2">&quot;PipelineBuilderContext&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Include solved pipeline sieve for adviser or Dependency Monkey on pipeline creation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">is_included</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_version</span><span class="p">:</span> <span class="n">PackageVersion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Filter out packages based on build time/installation issues..&quot;&quot;&quot;</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;os_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">runtime_environment</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;os_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">runtime_environment</span><span class="o">.</span><span class="n">operating_system</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">runtime_environment</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">has_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">has_python_solver_error</span><span class="p">(</span>
                <span class="n">package_version</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">package_version</span><span class="o">.</span><span class="n">locked_version</span><span class="p">,</span>
                <span class="n">package_version</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                <span class="o">**</span><span class="n">environment</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">NotFoundError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotAcceptable</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Removing package {package_version.to_tuple()!r} as it was not solved: {str(exc)!r}&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">has_error</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;without_error&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">NotAcceptable</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Removing package {package_version.to_tuple()!r} due to build time error on {environment!r}&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
<p>Another example of a sieve can be filtering packages that are pre-releases, but
pre-releases were disabled in <em>Pipenv</em> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;A step to filter out pre-releases in direct dependencies.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">from</span> <span class="nn">thoth.python</span> <span class="kn">import</span> <span class="n">PackageVersion</span>

<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">NotAcceptable</span>
<span class="kn">from</span> <span class="nn">..sieve</span> <span class="kn">import</span> <span class="n">Sieve</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..pipeline_builder</span> <span class="kn">import</span> <span class="n">PipelineBuilderContext</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@attr.s</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CutPreReleasesSieve</span><span class="p">(</span><span class="n">Sieve</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cut-off pre-releases if project does not explicitly allows them.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">should_include</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s2">&quot;PipelineBuilderContext&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Include cut-prereleases pipeline sieve for adviser or Dependency Monkey if pre-releases are not allowed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">is_included</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">prereleases_allowed</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_version</span><span class="p">:</span> <span class="n">PackageVersion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cut-off pre-releases if project does not explicitly allows them.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">prereleases_allowed</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Project accepts pre-releases, skipping cutting pre-releases step&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">package_version</span><span class="o">.</span><span class="n">semantic_version</span><span class="o">.</span><span class="n">prerelease</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotAcceptable</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Removing package {package_version.to_tuple()!r} - pre-releases are disabled&quot;</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>The parameter <cite>package_version</cite> is of type <cite>PackageVersion</cite> which is an
abstraction on top of a Python’s package in a version (stating all its
properties, see library <cite>thoth-python</cite> for more info). Note artifact hashes are
retrieved lazily once a final state is produced (hance the
<cite>PackageVersion.hashes</cite> property will in most cases be an empty array unless
the given package was already produced in one of the pipeline’s final states).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When to use a sieve?</p>
<p>If you want to evaluate addition of a single package without considering the current state in the resolution.</p>
</div>
</div>
<div class="section" id="step">
<h2>Step<a class="headerlink" href="#step" title="Permalink to this headline">¶</a></h2>
<p>The main purpose of a unit of type <a class="reference internal" href="thoth.adviser.html#thoth.adviser.step.Step" title="thoth.adviser.step.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">Step</span></code></a> is
to decide whether a creation of a new state out of an already existing one is
acceptable and what would be the score adjustment if the given step is
performed together with a justification reported to a user. A new state is
created out of an existing one by resolving direct dependencies of a not yet
resolved dependency in the dependency graph. Hence, the new state inherits all
the properties of the parent state and pipeline steps decide what is the impact
of adding new packages to the (expanded) parent state.</p>
<p>Note by resolving a dependency in a parent state, we possibly get multiple
states based on combinations of package types in different versions in which
dependencies may occur.</p>
<p>In other words, a step is performed to create new states closer to final states
out of an already found non-final state in the discrete state space of all
the possible states (final and non-final ones).</p>
<p>An implementation of a step accepts</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When to use a step?</p>
<p>If you want to evaluate acceptance of a package into a state and its impact.</p>
<p>An example can be:</p>
<ul class="simple">
<li><p>blocking two or more packages to be present in a state due to API incompatibilities spotted on runtime (Python is a dynamic programming language)</p></li>
<li><p>blocking a package from being present in resolved software stacks due to a native dependecy which is not present in the runtime environment</p></li>
<li><p>penalize stacks with packages because of security vulnerabilities found in packages forming the stack</p></li>
<li><p>prioritize packages in resolved software stacks because of good performance observations in software and hardware environment used</p></li>
<li><p>etc.</p></li>
</ul>
</div>
<p>You can find an example of a step implementation performing penalization if a
security vulnerability is found bellow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Penalize stacks with a CVE.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">from</span> <span class="nn">thoth.python</span> <span class="kn">import</span> <span class="n">PackageVersion</span>
<span class="kn">from</span> <span class="nn">thoth.storages.exceptions</span> <span class="kn">import</span> <span class="n">NotFoundError</span>

<span class="kn">from</span> <span class="nn">..step</span> <span class="kn">import</span> <span class="n">Step</span>
<span class="kn">from</span> <span class="nn">..state</span> <span class="kn">import</span> <span class="n">State</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..pipeline_builder</span> <span class="kn">import</span> <span class="n">PipelineBuilderContext</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@attr.s</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CvePenalizationStep</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Penalization based on CVE being present in stack.&quot;&quot;&quot;</span>

    <span class="n">PARAMETERS_DEFAULT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cve_penalization&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">should_include</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s2">&quot;PipelineBuilderContext&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Remove CVEs only for advised stacks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">is_adviser_pipeline</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">is_included</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">package_version</span><span class="p">:</span> <span class="n">PackageVersion</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]:</span>
        <span class="sd">&quot;&quot;&quot;Penalize stacks with a CVE.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cve_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_python_cve_records_all</span><span class="p">(</span>
                <span class="n">package_name</span><span class="o">=</span><span class="n">package_version</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">package_version</span><span class="o">=</span><span class="n">package_version</span><span class="o">.</span><span class="n">locked_version</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">NotFoundError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Package </span><span class="si">%r</span><span class="s2"> in version </span><span class="si">%r</span><span class="s2"> not found: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">cve_records</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Found a CVEs for </span><span class="si">%r</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">package_version</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">(),</span> <span class="n">cve_records</span>
            <span class="p">)</span>
            <span class="n">penalization</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cve_records</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;cve_penalization&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">penalization</span><span class="p">,</span> <span class="n">cve_records</span>

        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
</div>
<div class="section" id="stride">
<h2>Stride<a class="headerlink" href="#stride" title="Permalink to this headline">¶</a></h2>
<p>Units of type stride are the last pipeline units executed on final states which
keep fully resolved Python software stacks considering the given software
environment and hardware information as provided to the pipeline.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When to use a stride?</p>
<p>If you want to evaluate acceptance of a final state that will become pipeline product.</p>
</div>
<p>An example of a stride implementation can be a random decision stride which is
used in Dependency Monkey to sample state space of possible software stacks to
gather observations for adviser when recommending software stacks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Filter out states randomly.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">attr</span>

<span class="kn">from</span> <span class="nn">..state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">..stride</span> <span class="kn">import</span> <span class="n">Stride</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">NotAcceptable</span>
<span class="kn">from</span> <span class="nn">..enums</span> <span class="kn">import</span> <span class="n">DecisionType</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..pipeline_builder</span> <span class="kn">import</span> <span class="n">PipelineBuilderContext</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@attr.s</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RandomDecisionStride</span><span class="p">(</span><span class="n">Stride</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filter out states randomly.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">should_include</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s2">&quot;PipelineBuilderContext&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Remove CVEs only for advised stacks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">is_dependency_monkey_pipeline</span><span class="p">()</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">is_included</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">decision_type</span> <span class="o">==</span> <span class="n">DecisionType</span><span class="o">.</span><span class="n">RANDOM</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Flip a coin and decide - tails are not acceptable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">NotAcceptable</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;State with score {state.score!r} was randomly discarded by flipping a coin&quot;</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="wrap">
<h2>Wrap<a class="headerlink" href="#wrap" title="Permalink to this headline">¶</a></h2>
<p>Last but not least pipeline unit is called “wrap” as it wraps up the whole work done
on a state. It’s called each time a final step is produced and accepted by all the
strides. Note any operations on the <a class="reference internal" href="thoth.adviser.html#thoth.adviser.state.State" title="thoth.adviser.state.State"><code class="xref py py-class docutils literal notranslate"><span class="pre">thoth.adviser.state.State</span></code></a> are still
valid as this pipeline unit is called before creation of a pipeline product (if requested so).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When to use a wrap unit?</p>
<p>Each time you would like to do an operation on a fully resolved and accepted Python software stack
on the given environment. This can be also an external event - like signalizing progress
to an external service.</p>
</div>
</div>
<div class="section" id="afterword-for-pipeline-units">
<h2>Afterword for pipeline units<a class="headerlink" href="#afterword-for-pipeline-units" title="Permalink to this headline">¶</a></h2>
<p>All the sieves, steps and strides <em>should not</em> raise any exception - raising an
exception other than <a class="reference internal" href="thoth.adviser.html#thoth.adviser.exceptions.NotAcceptable" title="thoth.adviser.exceptions.NotAcceptable"><code class="xref py py-class docutils literal notranslate"><span class="pre">thoth.adviser.exceptions.NotAcceptable</span></code></a>
and <a class="reference internal" href="thoth.adviser.html#thoth.adviser.exceptions.EagerStopPipeline" title="thoth.adviser.exceptions.EagerStopPipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">thoth.adviser.exceptions.EagerStopPipeline</span></code></a> (used to terminate annealing
prematurely) causes undefined behaviour (mostly crashes on the annealing part).</p>
<p>Pipeline units of type boot and wrap <em>should not</em> raise any exception except
for <a class="reference internal" href="thoth.adviser.html#thoth.adviser.exceptions.EagerStopPipeline" title="thoth.adviser.exceptions.EagerStopPipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">thoth.adviser.exceptions.EagerStopPipeline</span></code></a> for premature end of annealing
in a nice, way.</p>
<p>All pipeline units should be atomic pieces and <a class="reference external" href="https://en.wikipedia.org/wiki/Unix_philosophy">they should do one thing
and do it well</a>. They were
designed to be small pieces forming complex resolution system.</p>
</div>
<div class="section" id="static-source-code-analysis-library-usage">
<h2>Static source code analysis - library usage<a class="headerlink" href="#static-source-code-analysis-library-usage" title="Permalink to this headline">¶</a></h2>
<p>A user can use static source code analysis on the client side when asking for
advises. In that case, sources are scanned for library imports and calls
(<a class="reference external" href="https://github.com/thoth-station/invectio">Invectio</a> is used). The gathered
library usage captures libraries and what symbols are used from these libraries
in sources. This information can be subsequently used in recommendations (in
the state generation pipeline) to target recommendations specific to user’s
application.</p>
<div class="section" id="recommendation-type">
<h3>Recommendation type<a class="headerlink" href="#recommendation-type" title="Permalink to this headline">¶</a></h3>
<p>To target user specific requirements for the recommended application stack,
there were introduced three types of recommendations:</p>
<ul class="simple">
<li><p><strong>LATEST</strong></p></li>
<li><p><strong>TESTING</strong></p></li>
<li><p><strong>STABLE</strong></p></li>
</ul>
<p><strong>Latest</strong> recommendations recommend the most latest versions of libraries.
This functionality somehow mimics raw pip or Pipenv but recommended latest
versions are already analyzed by Thoth and respect package source index
configuration the user used (annealing will become <a class="reference external" href="https://en.wikipedia.org/wiki/Hill_climbing">hill climbing</a>).</p>
<p><strong>Stable</strong> recommendations target the most suited software stacks which, based
on Thoth’s gathered observations, are considered as stable - always running in
the given runtime environment.</p>
<p><strong>Testing</strong> recommendation types recommend software for which there are no
negative observations but they might not behave stable in all cases.</p>
</div>
<div class="section" id="software-environment">
<h3>Software environment<a class="headerlink" href="#software-environment" title="Permalink to this headline">¶</a></h3>
<p>Software environment is yet another vector coming to the recommendation engine.
It states additional software present in the environment, such as operating
system, Python interpreter version or IPython information in case of Jupyter
Notebooks.</p>
<p>Software environment can be automatically detected by <a class="reference external" href="https://github.com/thoth-station/thamos">Thamos</a> - a user can use Thoth to get
recommendations for the same application when running in different software
(and also hardware) environments (for example different setup for a cluster and
a local desktop run).</p>
<p>Software environment used to run an application together with hardware
environment form “<em>runtime environment</em>”.</p>
</div>
<div class="section" id="hardware-environment">
<h3>Hardware environment<a class="headerlink" href="#hardware-environment" title="Permalink to this headline">¶</a></h3>
<p>Hardware environment is stating what hardware is present to run the given
application. <a class="reference external" href="https://github.com/thoth-station/thamos">Thamos</a> is capable to
perform hardware discovery as well (besides software environment discovery). An
example of hardware environment configuration can be GPU or CPU type.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">State expansion pipeline</a><ul>
<li><a class="reference internal" href="#a-foreword-for-units">A foreword for units</a></li>
<li><a class="reference internal" href="#pipeline-configuration-creation">Pipeline configuration creation</a></li>
<li><a class="reference internal" href="#boot">Boot</a></li>
<li><a class="reference internal" href="#sieve">Sieve</a></li>
<li><a class="reference internal" href="#step">Step</a></li>
<li><a class="reference internal" href="#stride">Stride</a></li>
<li><a class="reference internal" href="#wrap">Wrap</a></li>
<li><a class="reference internal" href="#afterword-for-pipeline-units">Afterword for pipeline units</a></li>
<li><a class="reference internal" href="#static-source-code-analysis-library-usage">Static source code analysis - library usage</a><ul>
<li><a class="reference internal" href="#recommendation-type">Recommendation type</a></li>
<li><a class="reference internal" href="#software-environment">Software environment</a></li>
<li><a class="reference internal" href="#hardware-environment">Hardware environment</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="performance.html"
                        title="previous chapter">Performance indicators</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="provenance_checks.html"
                        title="next chapter">Provenance Checks</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/pipeline.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="provenance_checks.html" title="Provenance Checks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="performance.html" title="Performance indicators"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Thoth team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>