<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Resolver design document &#8212; Thoth Adviser 0.4.0 documentation</title>
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Stack generation pipeline" href="pipeline.html" />
    <link rel="prev" title="Dependency Monkey Design Document" href="dependency_monkey.html" />

    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123174547-2']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="index.html">Thoth Adviser 0.4.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="resolver-design-document">
<span id="libdependency-graph"></span><h1>Resolver design document<a class="headerlink" href="#resolver-design-document" title="Permalink to this headline">¶</a></h1>
<p>This document describes the current and past implementations of Thoth’s
software stack resolution algorithm which is implemented on top of the graph
database. The main reason for creating this resolution algorithm are two
fundamental requirements from Thoth side:</p>
<ul class="simple">
<li><p>Provide a fast mechanism on how to generate software stacks for scoring (recommendations/advises).</p></li>
<li><p>Provide a fast mechanism on how to generate software stacks which should be used in Thoth’s Amun service (service for software stack validation and scoring) by <a class="reference internal" href="dependency_monkey.html#dependency-monkey"><span class="std std-ref">Dependency Monkey Design Document</span></a></p></li>
</ul>
<div class="section" id="queries-to-the-graph-database">
<h2>Queries to the graph database<a class="headerlink" href="#queries-to-the-graph-database" title="Permalink to this headline">¶</a></h2>
<p>Packages and their dependencies were obtained from the graph database (<a class="reference external" href="https://dgraph.io">Dgraph</a>). A query to graph database for transitive dependencies
retrieves a path to each package starting from each direct dependency. Given
the following dependencies (where A, B, C, D, E, F, G are packages in specific
versions):</p>
<ul class="simple">
<li><p>A depends on B</p></li>
<li><p>A depends on C</p></li>
<li><p>B depends on D</p></li>
<li><p>D depends on E</p></li>
<li><p>C depends on F</p></li>
<li><p>B depends on G</p></li>
</ul>
<p>The graph database query for retrieving transitive dependencies for direct
dependency A returns a list of lists stating which package depends on which
(until the end of dependency chaining is hit):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[</span>
<span class="go">  [A, B, D, E],</span>
<span class="go">  [A, B, G],</span>
<span class="go">  [A, C, F]</span>
<span class="go">]</span>
</pre></div>
</div>
<p>The cyclic dependencies are handled in the query (the last item in the chain
references back the item which started the cycle).</p>
<p>The actual query implemented in Thoth does not return values of packages. Based
on our performance observations, due to serialization, deserialization and
graph database server-side cache, it is much more efficient to retrieve
identifiers of these packages and ask for the actual package name, package
version and source index URL later on in parallel for each item in the
dependency chain (note that packages in the resulting query occur multiple
times based on packages which introduced them).</p>
<p>We are now primarily focused on the Python ecosystem, we use pip’s internal
resolution algorithm to resolve dependencies.  The very first implementation is
written in Python and can be found in the Thoth’s adviser repository.</p>
<p>The key idea is in creation in-memory N-ary graph constructed based on queries
to a graph database. This graph is subsequently traversed and the result of
each full traversal yields a fully pinned down stack.</p>
<a class="reference external image-reference" href="_static/dependency_graph.png"><img alt="DependencyGraph" src="_static/dependency_graph.png" /></a>
<p>By traversing the graph and reaching the leaf nodes, we generate software
stacks. Example stacks generated during the traversal:</p>
<ul class="simple">
<li><p>A1, C1, B1, D1</p></li>
<li><p>A1, C2, B2, D2</p></li>
</ul>
<p>The main downside for the Python implementation was memory consumption and time
spent in traversals to generate stacks. These issues were targeted in the new
C++ implementation (now used in adviser) which is described in the following
paragraph.</p>
</div>
<div class="section" id="c-c-implementation">
<h2>C/C++ Implementation<a class="headerlink" href="#c-c-implementation" title="Permalink to this headline">¶</a></h2>
<p>The next implementation was done in C/C++ and exposes its functionality as a
library which is loaded from the Python code. The Python code uses C bindings
available via <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> to communicate with the C implementation (see the
Python adapter for the created <code class="docutils literal notranslate"><span class="pre">so</span></code> library). The exposed C API than talks to
the underlying C++ implementation.</p>
<p>The stack generation is done in a standalone process which writes results into
a pipe. The pipe is used as inter-process communication - the Python process
reads stacks as produced by the C/C++ library into a pipe, scores them and
constructs the resulting adviser report with the recommended scores,
justification and additional metadata.</p>
<p>The use of pipe was chosen as to advantage with easy inter-process
communication. The C/C++ implementation operates on top of numbers which
represent packages in specific versions, mapping of packages to a specific type
(substituted with a number) and a list capturing structure between packages.
These numbers are easy to serialize and deserialize when the IPC via pipe is
done. Moreover, it makes the C/C++ implementation reusable (not tightly bound
to a Python resolving, but in any N-ary graph traversal we will need later).</p>
<p>One of the benefits of using a separate process is also possible OOM issues. If
the stack producer goes out of memory, it gets killed (in cluster deployment,
on OpenShift) and the the main scoring process can report partial results to
users.</p>
<p>Let’s suppose we have the same packages as described in the Python
implementation above. The C++ implementation does not create immediately the
whole dependency graph in memory to perform traversals, but rather expands
traversed nodes of transitive dependencies when needed. Moreover, using raw
numbers which map to packages and package types makes the implementation much
more memory efficient.</p>
<p>Mapping is performed in the following manner:</p>
<ul class="simple">
<li><p>Each package is mapped to a number</p></li>
<li><p>Each package of the same type has assigned same “type” number</p></li>
<li><p>Paths as returned from the graph database are turned into a list of pairs where each pair states a package on the first position and its direct dependency on the second position</p></li>
</ul>
<p>An example can be the dependency graph from the previous section:</p>
<a class="reference external image-reference" href="_static/dependency_graph.png"><img alt="DependencyGraph" src="_static/dependency_graph.png" /></a>
<p>Here, there are grouped the same packages (same package names, but different
package versions and/or package source indexes) of type “a” (this can be for
example package “numpy” in version 1, 2 and 3) into one node of N-ary graph. In
the C/C++ implementation these packages have assigned the same type identifier
(for example 0) which groups them into the same package type category. With the
same pattern, there are grouped packages of type “b” (versions 1, 2) into the
same category identified by a number (for example 1) and so on. This mapping is
called “dependency_types” in the C/C++ implementation. An example mapping for
each package can be:</p>
<p>A1: 0; A2: 0; A3: 0;
B1: 1; B2: 1;
C1: 2; C2: 2; C3: 2;
D1: 3; D2: 3;</p>
<p>Another mapping used in the C/C++ implementation is the mapping of packages in
a specific version from a specific Python source index (this tuple uniquely
distinguishes packages in the Python ecosystem). For the example above, the
mapping can be:</p>
<p>A1: 0; A2: 1; A3: 2;
B1: 3; B2: 4;
C1: 5; C2: 6;
D1: 7; D2: 8;</p>
<p>The last parameter to the C/C++ implementation (omitting metadata information
such as sizes of arrays submitted to C/C++ implementation) is a list of number
pairs. The first pair states a package and the second pair states its
dependency. Basically, this array represents serialized paths as returned from
the graph traversal query. An example can be:</p>
<p>[  [0; 5]; [0; 6]; [1; 5]; [1; 6]; [1; 2], … ]</p>
<p>In this case, the first item in the array [0; 5] represents the fact A1 depends
on C1, [1; 6] represents dependency between A2 and C2 and so on.</p>
<p>These parameters are then used to construct the dependency graph as shown above
dynamically during traversal as well as to perform resolution checks (such as
no two packages of the same type can be installed at the same time - e.g. C1
and C2).</p>
</div>
<div class="section" id="library-implementation">
<h2>Library implementation<a class="headerlink" href="#library-implementation" title="Permalink to this headline">¶</a></h2>
<p>The library is present in the <code class="docutils literal notranslate"><span class="pre">thoth/adviser/python/bin</span></code> directory. You can
find all the relevant files (<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>) to build this
library. The repository is by default shipped with an <code class="docutils literal notranslate"><span class="pre">*.so</span></code> file (the file
produced by <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>) and subsequently loaded by the adviser implementation
using Python’s <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>. This library is executed as a standalone process
which writes stacks into a pipe from which they are consumed in the main
adviser’s Python process and scored/submitted to Amun for inspections.</p>
<p>To build this library on your own, you can use <code class="docutils literal notranslate"><span class="pre">make</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span>
</pre></div>
</div>
<p>Also make sure the C++ STL ABI is compatible when you are deploying adviser,
otherwise you can encounter issues like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>OSError: /lib64/libstdc++.so.6: version `CXXABI_1.3.8&#39; not found (required by /opt/app-root/src/thoth/adviser/python/bin/libdependency_graph.so)
</pre></div>
</div>
<p>To target this issue, there was created a containerized build, which can be
done using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">container</span><span class="o">-</span><span class="n">build</span>
</pre></div>
</div>
<p>This build will produce the <code class="docutils literal notranslate"><span class="pre">libdependency_graph.so</span></code> file in a container (use
the base image you would like to be compatible with) and copied to host for
use.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Resolver design document</a><ul>
<li><a class="reference internal" href="#queries-to-the-graph-database">Queries to the graph database</a></li>
<li><a class="reference internal" href="#c-c-implementation">C/C++ Implementation</a></li>
<li><a class="reference internal" href="#library-implementation">Library implementation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="dependency_monkey.html"
                        title="previous chapter">Dependency Monkey Design Document</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pipeline.html"
                        title="next chapter">Stack generation pipeline</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/libdependency_graph.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pipeline.html" title="Stack generation pipeline"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="dependency_monkey.html" title="Dependency Monkey Design Document"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Thoth team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.1.
    </div>
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>