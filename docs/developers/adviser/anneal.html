<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Adaptive simulated annealing &#8212; Thoth Adviser 0.6.0 documentation</title>
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Dependency Monkey Design Document" href="dependency_monkey.html" />
    <link rel="prev" title="Thoth Adviser" href="index.html" />

    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123174547-2']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="index.html">Thoth Adviser 0.6.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="adaptive-simulated-annealing">
<span id="anneal"></span><h1>Adaptive simulated annealing<a class="headerlink" href="#adaptive-simulated-annealing" title="Permalink to this headline">¶</a></h1>
<p>A very first implementation of Adviser and Dependency Monkey was designed to
load the whole dependency graph into memory and subsequently perform operations
on the weighted dependency graph. This way the dependency graph was adjusted
based on scores on edges and by traversing the dependency graph, there were
produced software stacks. Over time we abandoned this approach as it did not
scale with size of software stacks (e.g. a TensorFlow Python stack  required
circa 2.5k queries to the database just for dependency graph retrieval) and
<a class="reference external" href="https://stackoverflow.blog/2017/09/06/incredible-growth-python//">given the trend in Python ecosystem</a> this
solution would also not be scalable.</p>
<p>The new implementation uses a stochastic approach based on Adaptive
simulated annealing (see <a class="reference external" href="https://en.wikipedia.org/wiki/Adaptive_simulated_annealing">Wikipedia for a brief info</a> and also
<a class="reference external" href="https://en.wikipedia.org/wiki/Simulated_annealing">simulated annealing</a>).
Software stacks are lazily expanded from initial states. The initial states are
formed out of combinations computed on all the resolved direct dependencies. As
an example, we can create a software stack that requests two packages to be
installed - <cite>tensorflow</cite> and <cite>flask</cite> - with specific version ranges:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">tensorflow&gt;=1.14,0</span>
<span class="go">flask&gt;=1.0.0&lt;=1.1.0</span>
</pre></div>
</div>
<p>Thoth in this case performs offline resolution (based on pre-computed data in
the database which state how dependencies are structured) of direct
dependencies and finds matching releases given version range specification - an
illustrative example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">tensorflow==2.0.0</span>
<span class="go">tensorflow==1.14.0</span>
<span class="go">tensorflow==1.15.0</span>
<span class="go">flask==1.1.0</span>
<span class="go">flask==1.0.0</span>
</pre></div>
</div>
<p>These releases are kept in buckets of a same package type (<cite>tensorflow</cite> and
<cite>flask</cite>) and sorted based on versions. All the possible combinations of these
direct dependencies create initial states (as described above) - in this case
we have 3*2=6 combinations in total:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">([</span><span class="s2">&quot;tensorflow==2.0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;tensorflow==1.15.0&quot;</span><span class="p">,</span> <span class="s2">&quot;tensorflow==1.15.0&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;flask==1.1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;flask==1.0.0&quot;</span><span class="p">])))</span>
<span class="go">[(&#39;tensorflow==2.0.0&#39;, &#39;flask==1.1.0&#39;),</span>
<span class="go"> (&#39;tensorflow==2.0.0&#39;, &#39;flask==1.0.0&#39;),</span>
<span class="go"> (&#39;tensorflow==1.15.0&#39;, &#39;flask==1.1.0&#39;),</span>
<span class="go"> (&#39;tensorflow==1.15.0&#39;, &#39;flask==1.0.0&#39;),</span>
<span class="go"> (&#39;tensorflow==1.14.0&#39;, &#39;flask==1.1.0&#39;),</span>
<span class="go"> (&#39;tensorflow==1.14.0&#39;, &#39;flask==1.0.0&#39;)]</span>
</pre></div>
</div>
<p>Each and every combination creates an initial state - see <cite>State</cite> abstraction
in sources for representation of a single state which is about to be expanded
resolved.</p>
<p>States are added to a <a class="reference external" href="https://en.wikipedia.org/wiki/Beam_search">beam</a> which
is designed to limit search space given the memory resources available (keep
only <cite>beam.width</cite> most promising states to be expanded/resolved).</p>
<p>The adaptive simulated annealing part of adviser’s resolution algorithm takes
either a top rated state for expansion or, based on probability, picks some
another state from beam. This state is expanded by picking one dependency from
unresolved dependency listing and obtaining its direct dependencies making the
dependency resolved and direct dependencies becoming part of unresolved
dependency listing. A state is in so-called “final state” if all the dependencies
were resolved and there is no package version clash during resolution (no two
packages of a same type but in different versions or packages of a same type
coming from a different Python package source index - this is not acceptable in
Python packaging). The probability of picking a neighbour state (and not the
highest rated stack) from beam is computed based on, besides other parameters,
the temperature function which respects number of iterations and number of
final states produced so far (thus “adaptive” simulated annealing).</p>
<p>An example of an adaptive simulated annealing run that produced 1000 Python
stacks (final states) with no observations on scored packages and states can be
seen on the following figure. As the database for scoring states is empty
(Python stacks were just resolved without any guidenance), the probability of
picking a random state from beam is very high (the algorithm is looking for a
state which would be better than score of 0.0). This acceptance probability is
kept even the temperature dropped.</p>
<a class="reference external image-reference" href="_static/history_no_data.png"><img alt="Resolving software stacks with simulated annealing with no data available." src="_images/history_no_data.png" /></a>
<p>On the figure below, there was randomized scoring of top rated states for
demonstration purposes. As can be seen, the acceptance probability for picking
a neighbour state for expansion is decreasing with number of final states
produced and with decreasing temperature during iterations. This caused picking
the highest rated states for expansion and producing final states out of them
(fully resolved Python software stacks).</p>
<a class="reference external image-reference" href="_static/history_random_data.png"><img alt="Resolving software stacks with simulated annealing with random data." src="_images/history_random_data.png" /></a>
<p>The last figure shows annealing behavior when there is found just one final
state and others are filtered out based on the score filtering (the final
states found have same score as the already produced ones so they are
discarded). As can be seen, the acceptance probability is kept high during the
whole annealing and the run is terminated once the whole state space is
explored (no other stack with different score than the produced one is found -
this can be accomplished by using
<a class="reference internal" href="thoth.adviser.strides.html#thoth.adviser.strides.ScoreFilteringStride" title="thoth.adviser.strides.ScoreFilteringStride"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sieve</span></code></a> stride).</p>
<a class="reference external image-reference" href="_static/history_random_data.png"><img alt="Only one stack found during annealing, other stacks were discarded based on score filtering" src="_images/history_one_found.png" /></a>
<div class="section" id="expansion-of-states">
<h2>Expansion of states<a class="headerlink" href="#expansion-of-states" title="Permalink to this headline">¶</a></h2>
<p>The expansion of states clones the expanded state and creates a combination of
all the packages which can occur following same principle similar to the one
described above when generating initial states (except the expanded state is
used as a “base state” which is cloned and used).</p>
</div>
<div class="section" id="using-pipeline-in-annealing">
<h2>Using pipeline in annealing<a class="headerlink" href="#using-pipeline-in-annealing" title="Permalink to this headline">¶</a></h2>
<p>The simulated annealing-based software stack resolution is respecting adviser
pipelines as described in <a class="reference internal" href="pipeline.html#pipeline"><span class="std std-ref">adviser pipeline section</span></a>. There are
implemented three abstractions to simplify package picking and handling:</p>
<ul class="simple">
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.boot.Boot" title="thoth.adviser.boot.Boot"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boot</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.sieve.Sieve" title="thoth.adviser.sieve.Sieve"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sieve</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.step.Step" title="thoth.adviser.step.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">Step</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.stride.Stride" title="thoth.adviser.stride.Stride"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stride</span></code></a></p></li>
<li><p><a class="reference internal" href="thoth.adviser.html#thoth.adviser.wrap.Wrap" title="thoth.adviser.wrap.Wrap"><code class="xref py py-class docutils literal notranslate"><span class="pre">Wrap</span></code></a></p></li>
</ul>
<p>See the <a class="reference internal" href="pipeline.html#pipeline"><span class="std std-ref">adviser pipeline section</span></a> for more info.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Adaptive simulated annealing</a><ul>
<li><a class="reference internal" href="#expansion-of-states">Expansion of states</a></li>
<li><a class="reference internal" href="#using-pipeline-in-annealing">Using pipeline in annealing</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Thoth Adviser</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="dependency_monkey.html"
                        title="next chapter">Dependency Monkey Design Document</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/anneal.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dependency_monkey.html" title="Dependency Monkey Design Document"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Thoth Adviser"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Thoth team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>